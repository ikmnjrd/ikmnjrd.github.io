<!DOCTYPE html><html lang="ja" prefix="og:https://ikmnjrd.github.io/ns#"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1.0"/><meta name="google-site-verification" content="mSJsnnYDqT7YzaY5pkqKhPHifGmwW4pCr2B97rSnleU"/><title>Nuxt.jsの記事 | ikmnjrd.github.io</title><meta name="next-head-count" content="4"/><meta name="author" content="ikmnjrd"/><meta charSet="utf-8"/><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"/><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"/><link rel="manifest" href="/site.webmanifest"/><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"/><link rel="alternate" type="application/rss+xml" title="ikmnjrd.github.io - rss" href="/rss/feed.xml"/><meta name="msapplication-TileColor" content="#da532c"/><meta name="theme-color" content="#ffffff"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-W6W9YD5G74"></script><script>
                  window.dataLayer = window.dataLayer || [];
                  function gtag(){dataLayer.push(arguments);}
                  gtag('js', new Date());
                  gtag('config', 'G-W6W9YD5G74', { page_path: window.location.pathname });
                </script><link rel="preload" href="/_next/static/css/94a47e4c6190aca3.css" as="style" crossorigin=""/><link rel="stylesheet" href="/_next/static/css/94a47e4c6190aca3.css" crossorigin="" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" crossorigin="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-59c5c889f52620d6.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/framework-fa877b8be7542607.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/main-a25bb6cd49197ab7.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/pages/_app-2b944fa6f28669ad.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/pages/tag/%5Btag%5D-8273f47c33665ffd.js" defer="" crossorigin=""></script><script src="/_next/static/xiblPHFM0KQGs956nTgS2/_buildManifest.js" defer="" crossorigin=""></script><script src="/_next/static/xiblPHFM0KQGs956nTgS2/_ssgManifest.js" defer="" crossorigin=""></script></head><body class="dark:bg-newmo-800 text-newmo-400 dark:text-newmo-100"><div id="__next"><header class="mb-4 p-4 md:px-8 grid grid-cols-1 md:grid-cols-2 max-w-screen-lg mx-auto"><h1 class=""><a class="header-text md:text-5xl text-3xl font-serif decoration-dotted hover:opacity-50 hover:underline active:opacity-30" href="/">ikmnjrd.github.io</a><button class="md:ml-3 ml-2" aria-label="Toggle Theme"><img width="24px" height="24px" class="svg-icon md:w-10 hover:opacity-50 active:opacity-30" src="/light_mode_white_24dp.svg" alt="Dark Mode Status is false" aria-hidden="true"/></button></h1><nav class="text-right"><button type="button"><span class="header-text mr-4 md:text-3xl text-2xl font-serif decoration-dotted hover:opacity-50 hover:underline active:opacity-30">Search</span></button><dialog class="modal_modal__fxCNj modal_micromodal__slide__kofBh"><div class="modal_modal__overlay__vnFmS" tabindex="-1"><div class="modal_modal__container__Id_PX" role="dialog" aria-modal="true"></div></div></dialog><a class="header-text mr-4 md:text-3xl text-2xl font-serif decoration-dotted hover:opacity-50 hover:underline active:opacity-30" href="/about">About</a><a class="header-text md:text-3xl text-2xl font-serif decoration-dotted hover:opacity-50 hover:underline active:opacity-30" href="/tags">Tags</a></nav></header><main class="max-w-2xl md:mx-auto mx-4 flex flex-col"><h1 class="text-3xl pt-8 pb-4">Nuxt.js<!-- -->の投稿記事一覧</h1><div><li><a class="hover:underline hover:text-newmo-400 visited:text-newmo-300" href="/blog/nuxt-auth">Nuxt.jsのAuthモジュール(@nuxtjs/auth-next)をわからないなりにざっくり解説する</a></li></div></main><footer class="text-center text-sm" role="contentinfo"><div class="footer-content"><ul class="flex items-center justify-between max-w-[150px] mx-auto"><li><a href="https://x.com/ikmnjrd" target="_blank" rel="nofollow noopener noreferrer" title="x" class="footer-svg hover:opacity-50 block"><svg xmlns="http://www.w3.org/2000/svg" width="1.8em" height="1.8em" viewBox="0 0 1200 1227" fill="#fff"><path d="M714.163 519.284L1160.89 0H1055.03L667.137 450.887L357.328 0H0L468.492 681.821L0 1226.37H105.866L515.491 750.218L842.672 1226.37H1200L714.137 519.284H714.163ZM569.165 687.828L521.697 619.934L144.011 79.6944H306.615L611.412 515.685L658.88 583.579L1055.08 1150.3H892.476L569.165 687.854V687.828Z" fill="white"></path></svg></a></li><li><a href="https://github.com/ikmnjrd" target="_blank" rel="nofollow noopener noreferrer" title="GitHub" class="footer-svg header-text hover:opacity-50 block"><svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" viewBox="0 0 24 24" fill="#fff" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg></a></li><li><a href="https://ikmnjrd.github.io/rss/feed.xml" target="_blank" rel="nofollow noopener noreferrer" title="RSS" class="footer-svg header-text hover:opacity-50 block"><svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" viewBox="0 0 24 24" fill="#fff" stroke="currentColor" stroke-width="2.3" stroke-linecap="round" stroke-linejoin="round"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a></li></ul><p class="pt-4">©︎ikmnjrd -<!-- --> <time dateTime="Mon Jul 29 2024 14:55:41 GMT+0000 (Coordinated Universal Time)">2024</time></p></div><div class="wave"></div><div class="wave"></div></footer></div><script id="__NEXT_DATA__" type="application/json" crossorigin="">{"props":{"pageProps":{"tag":"Nuxt.js","posts":[{"slug":"nuxt-auth","frontmatter":{"title":"Nuxt.jsのAuthモジュール(@nuxtjs/auth-next)をわからないなりにざっくり解説する","description":"SPA・SSRの認証ライブラリらしい動きに焦点を当てて説明をする","date":"2023-05-21","tag":["Nuxt.js","JavaScript","Vue"]},"content":"\n### TL;DR\n- CookieとBrowser Storage(Local Storage)を使ってる\n- Cookieが消失することを踏まえ、expires/max-ageは本来的な意味で使っていない\n\n### 時勢の愚痴\nNuxt3.5のリリースが発表された最近ですが、nuxt-communityで開発されているAuthモジュールがいまだに3系に対応できておらず、よくわからん会社がNextAuth(Authentication for Next.js)をラップして作ってるものがNuxt3系をサポートしているよ！なんてことをREADMEに書く始末。  \nそんなNuxtのAuthモジュールの、2系で動いてるものを見た時に理解した一部を説明します。\n\n### 本解説の前提\nローカルスキーマを拡張した[リフレッシュスキーマ](https://auth.nuxtjs.org/schemes/refresh)をもとに解説しています。  \n設定値の例としては以下です。\n```js\nauth: {\n    cookie: {\n      options: {\n        secure: true,\n        sameSite: 'lax',\n        maxAge: 60 * 60 * 24 * 90\n      }\n    },\n    strategies: {\n      local: {\n        scheme: 'refresh',\n        token: {\n          property: 'access_token',\n          maxAge: 60 * 60 * 24\n        },\n        refreshToken: {\n          property: 'refresh_token',\n          data: 'refresh_token',\n          maxAge: 60 * 60 * 24 * 30\n        },\n      }\n    }\n}\n```\n\n\n### @nuxtjs/auth-nextの仕組み\n認証に関わる情報が置かれる場所は主に以下の4つです。\n- Local State(ライブラリ定義)\n- Universal Storage(ライブラリ定義)\n- Cookie(Web標準)\n- Browser Storage(Local Storage)(Web標準)\n\nLocal Stateはローカルな変数やrefオブジェクトだと理解してもらうとして、CookieもBrowser Storageも情報の保存場所としては馴染み深いと思います。  \n残るUniversal Storageは、gitでいうところのstagingエリアで、Local Stateに値を入れることをgit commitだと考えると良いかもです。\n\n\u003cimg alt=\"手書き概要\" src=\"https://i.gyazo.com/6f4ce193bc7158ddbc396e3743ebe384.png\" height=\"250\"\u003e\n\nUniversal Storageの必要性がないかと思われるかもしれませんが、次のような用途があります。  \n\nWebサイトに初回のGETリクエストしたユーザーのブラウザに保存されてる認証情報から取り出せるのは基本的にCookieからのみです。  \nそのため、期限が切れておらず正しい認証情報であれば、SSRをするのに必要な認証情報をLocal Stateに保存すればSSRした結果をユーザーが受け取れてハッピーですが、認証情報が切れている場合は最後までSSRさせてあげることができません。そんな時に役立つのがUniversal StateとBrowser Storageです。  \n\n一般的にCookieよりもBrowser Storageに保存したデータの方が長くユーザーのブラウザ内で生き残ります。  \nそのため、`@nuxtjs/auth-next`では、Cookieに保存する項目(key)が以下のようになっています。\n- アクセストークン\n- リフレッシュトークン\n- アクセストークンの有効期限\n- リフレッシュトークンの有効期限\n\nCookieには`expires/Max-Age`という項目がありますが、`@nuxtjs/auth-next`においてはデフォルトで2週間となっており、ドキュメント内で説明される有効期限とは`別物`となっています。そのため、\n\u003e アクセストークンの有効期限のvalue \u003e `expires/Max-Age`\n\u003e\nといった状況が生まれます。こうなった場合に`@nuxtjs/auth-next`では特に設定をしなくても使用することになっているBrowser Storageに保存していたアクセストークンやリフレッシュトークンの値を取り出し、認証チャレンジに使用することになっています。\n\n\u003cimg alt=\"手書き概要2\" src=\"https://i.gyazo.com/5ab80a9ae3b8ce6e8375aff6015ef72f.jpg\" height=\"300\"\u003e\n\nここまで読んでくれた人には申し訳ありませんが、私の理解はここまでです。\n\n### CookieとBrowser Storageに分かれているメリット/デメリット\n- メリット\n  - Cookieのドメイン属性の変更をしてデプロイをしたとき、すでにユーザーが持ってるアクセストークン等が引き続き利用され、期限が切れたタイミングで新規Cookieに切り替わる\n- デメリット\n  - 複雑度が増す\n\n### Nuxt3サポートがされない理由の考察\nSPA/SSR/SSGモード、認証方式、fetchライブラリ、ストアなどの問題が一番絡み合い、当ライブラリとしても色々な認証方法をサポートしてきた歴史からも互換が切り切れず身動きが取れてない状態だと推測してます。  \n\n超雑にようやくすると、「自分でやってくれ」というコメントが好意的なリアクションが多く、受け入れられているようです。\n\u003e It would be best if you had released this with at least some basic necessity modules (like auth). There are lots of people using Nuxt. Not all will get understand this thing they will have to do it on their own. It's good that you released it but its also affects people with extra burdens. Keep this in mind.\n\u003e \n\u003e I am seeing many peoples not shifting to Nuxt 3 because of these basic things.\n\u003e\n\u003ePeople are just stuck in between because now you can't even install Nuxt 2 freshly. It throughs a Fatal error while running.\n\u003e\n\u003eAnyways, it's great to see you guys work so hard on so many things! I really appreciate your contributions to the world. No hard feelings! :)\n\u003e \u003ccite\u003e[Compatibility with Nuxt 3?\n#1805](https://github.com/nuxt-community/auth-module/issues/1805#issuecomment-1328877117)\u003c/cite\u003e\n\n### 参考文献\n- [GitHub - nuxt-community/auth-module: Zero-boilerplate authentication support for Nuxt.js!](https://github.com/nuxt-community/auth-module)\n"}]},"__N_SSG":true},"page":"/tag/[tag]","query":{"tag":"Nuxt.js"},"buildId":"xiblPHFM0KQGs956nTgS2","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>