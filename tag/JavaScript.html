<!DOCTYPE html><html lang="ja"><head><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"/><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"/><link rel="manifest" href="/site.webmanifest"/><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"/><meta name="msapplication-TileColor" content="#da532c"/><meta name="theme-color" content="#ffffff"/><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>JavaScriptの記事 | ikmnjrd.github.io</title><meta name="next-head-count" content="3"/><link rel="preload" href="/_next/static/css/71ad17a49bdc42ce.css" as="style"/><link rel="stylesheet" href="/_next/static/css/71ad17a49bdc42ce.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-69bfa6990bb9e155.js" defer=""></script><script src="/_next/static/chunks/framework-91d7f78b5b4003c8.js" defer=""></script><script src="/_next/static/chunks/main-101cfeaa18eb0e64.js" defer=""></script><script src="/_next/static/chunks/pages/_app-fa3bfe785da18b73.js" defer=""></script><script src="/_next/static/chunks/pages/tag/%5Btag%5D-d8e586cb889c12f6.js" defer=""></script><script src="/_next/static/Tmn5csMnttd8s5PKivS8U/_buildManifest.js" defer=""></script><script src="/_next/static/Tmn5csMnttd8s5PKivS8U/_ssgManifest.js" defer=""></script><script src="/_next/static/Tmn5csMnttd8s5PKivS8U/_middlewareManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><div class=" text-newmo-400"><header><div class="mb-4 p-4 md:px-8 flex items-end justify-between"><h1 class="col-start-1 col-end-6"><a alt="top" class="header-text md:text-5xl text-3xl font-serif decoration-dotted hover:opacity-50 hover:underline active:opacity-30" href="/">ikmnjrd.github.io</a></h1><div class="col-start-6 col-end-7 items-end"><a alt="tags" class="header-text md:text-3xl text-2xl font-serif decoration-dotted hover:opacity-50 hover:underline active:opacity-30" href="/tags">Tags</a></div></div></header><main class="container mx-auto"><h2>JavaScript<!-- -->の投稿記事一覧</h2><div><li><a class="hover:underline hover:text-newmo-400 visited:text-newmo-300" href="/blog/Next-webpack">Next.jsがWebpackを使うから嫌いという話</a></li><li><a class="hover:underline hover:text-newmo-400 visited:text-newmo-300" href="/blog/next-sitemap-sample">Next.jsのサンプル集を参考にサイトマップを作成しようとしたらエラー</a></li></div></main><footer class="text-center py-5 text-sm text-newmo-300">©︎ikmnjrd - <!-- -->2022</footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"tag":"JavaScript","posts":[{"slug":"Next-webpack","frontmatter":{"title":"Next.jsがWebpackを使うから嫌いという話","date":"2022-02-09","tag":["webpack","Next.js","JavaScript"]},"content":"\n今まであまりrequireとimportなどの違いを意識できていない人間。\nNext.jsをプロジェクトに導入するのは賛成をとるが、個人のプロジェクトにはあまり使いたくないなーと思う程度の距離感を保っていた人間だった。現在無職。\n\nしかし、新たな職場を探すにあたってReactは使うのにNext.jsを触ったことがないというのは自分の選択肢を狭めるだけだと考え、無職期間に作り直そうとしていたRuby(Jekyll)製ブログを、Next.jsのSSGの仕組みを用いて作ることにした。（本当はメジャーバージョンがリリースされたばかりのeleventy.jsを使って作りたかった。フレームワークに求めているもの的にもeleventyの方が合っていたと今も感じる。1週間ほどはeleventy.js製のブログだった時期もある。）\n\n同リポジトリ内にマークダウンでブログ記事を上げるため、ビルド時に色々なものを生成したい要件が出てくる。Next.jsは内部でwebpackを使っていて`next.config.js`ではその一端を見ることができる。\n\n```javascript\nmodule.exports = {\n  reactStrictMode: true,\n  webpack(config, { isServer }) {\n    if (isServer) {\n      require('./scripts/generate-sitemap.js')\n    }\n  }\n}\n```\n\nwebpackはCommonJSで書かれていることは事前知識として知っていた。\n\nとは言ってもimportやexportが使いたい。`package.json`に`\"type\": \"module\"`を追加する方法などを試してみるが、最終的にproduction buildの際のfsモジュールが解決できないとか`Import trace for requested module:\n./pages/_app.js`などのエラーメッセージを残して終了していくプログラムを見るとイライラしてくる。\n\n勉強のためとはいえ、今度からNode.jsではなくDenoを使おうかなという気持ちになった。\n\n\n\n### 周辺用語\n- commonJS\n- ESModules\n- ES6(ES2015)\n\n### 参考文献\n- [Build a sitemap generator in Next.js - LogRocket Blog](https://blog.logrocket.com/build-sitemap-generator-nextjs/)\n- [Support ES module format (ESM) in next.config.js #9607](https://github.com/vercel/next.js/issues/9607)\n- [Support ES module format (ESM) in next.config.js #32239](https://github.com/vercel/next.js/discussions/32239)"},{"slug":"next-sitemap-sample","frontmatter":{"title":"Next.jsのサンプル集を参考にサイトマップを作成しようとしたらエラー","date":"2022-02-08","tag":["Node.js","Next.js","JavaScript"]},"content":"エラーに遭遇しました。\n\n### 環境\n- Node: v16.13.2\n- Next.js: 12.0.10\n- globby: 13.1.1\n\n[公式のサンプル集の「with-sitemap」](https://github.com/vercel/next.js/tree/canary/examples/with-sitemap)では以下のようなスクリプトをサーバー実行時に（`next.config.js`のisServerオブションをフラグにして）実行している。\n\n\n./scripts/generate-sitemap.js\n```javascript\nconst fs = require('fs')\nconst globby = require('globby')\n\nfunction addPage(page) {\n  const path = page.replace('pages', '').replace('.js', '').replace('.mdx', '')\n  const route = path === '/index' ? '' : path\n\n  return `  \u003curl\u003e\n    \u003cloc\u003e${`${process.env.WEBSITE_URL}${route}`}\u003c/loc\u003e\n    \u003cchangefreq\u003ehourly\u003c/changefreq\u003e\n  \u003c/url\u003e`\n}\n\nasync function generateSitemap() {\n  // Ignore Next.js specific files (e.g., _app.js) and API routes.\n  const pages = await globby([\n    'pages/**/*{.js,.mdx}',\n    '!pages/_*.js',\n    '!pages/api',\n  ])\n  const sitemap = `\u003curlset xmlns=\"http://www.sitemaps.org/schemas/sitemap/0.9\"\u003e\n${pages.map(addPage).join('\\n')}\n\u003c/urlset\u003e`\n\n  fs.writeFileSync('public/sitemap.xml', sitemap)\n}\n\ngenerateSitemap()\n\n```\n\n\n遭遇したエラーは以下\n\n```bash\nError [ERR_REQUIRE_ESM]: require() of ES Module ./node_modules/globby/index.js from ./scripts/generate-sitemap.js not supported.\nInstead change the require of index.js in ./scripts/generate-sitemap.js to a dynamic import() which is available in all CommonJS modules.\n```\n\n最新のglobbyからはCommonJSが省かれたらしい。\n\n\n### 解決策\npackage.jsonを以下のように書き換え、`$npm i`を実行\n```json\n\"globby\": \"^13.1.1\",\n```\n↓\n```json\n\"globby\": \"^11.0.1\",\n```\n\nインストール後、ビルド時に`./public/sitemap.xml`が無事出力された。\n\n\n### 周辺用語\n- commonJS\n- ESModules\n\n\n### 参考文献\n- [Build a sitemap generator in Next.js - LogRocket Blog](https://blog.logrocket.com/build-sitemap-generator-nextjs/)"}]},"__N_SSG":true},"page":"/tag/[tag]","query":{"tag":"JavaScript"},"buildId":"Tmn5csMnttd8s5PKivS8U","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>