<!DOCTYPE html><html lang="ja" prefix="og:https://ikmnjrd.github.io/ns#"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1.0"/><meta name="google-site-verification" content="mSJsnnYDqT7YzaY5pkqKhPHifGmwW4pCr2B97rSnleU"/><title>JavaScriptの記事 | ikmnjrd.github.io</title><meta name="next-head-count" content="4"/><meta name="author" content="ikmnjrd"/><meta charSet="utf-8"/><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"/><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"/><link rel="manifest" href="/site.webmanifest"/><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"/><link rel="alternate" type="application/rss+xml" title="ikmnjrd.github.io - rss" href="/rss/feed.xml"/><meta name="msapplication-TileColor" content="#da532c"/><meta name="theme-color" content="#ffffff"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-W6W9YD5G74"></script><script>
                  window.dataLayer = window.dataLayer || [];
                  function gtag(){dataLayer.push(arguments);}
                  gtag('js', new Date());
                  gtag('config', 'G-W6W9YD5G74', { page_path: window.location.pathname });
                </script><link rel="preload" href="/_next/static/css/09f40f07fa9bc7a3.css" as="style" crossorigin=""/><link rel="stylesheet" href="/_next/static/css/09f40f07fa9bc7a3.css" crossorigin="" data-n-g=""/><link rel="preload" href="/_next/static/css/36bd5e037ff9129c.css" as="style" crossorigin=""/><link rel="stylesheet" href="/_next/static/css/36bd5e037ff9129c.css" crossorigin="" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" crossorigin="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-8fa1640cc84ba8fe.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/framework-5429a50ba5373c56.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/main-a25bb6cd49197ab7.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/pages/_app-79523d5a77875659.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/pages/tag/%5Btag%5D-1bd66b708855fd32.js" defer="" crossorigin=""></script><script src="/_next/static/VqcCu3B2NG7b3qjj5q9Nd/_buildManifest.js" defer="" crossorigin=""></script><script src="/_next/static/VqcCu3B2NG7b3qjj5q9Nd/_ssgManifest.js" defer="" crossorigin=""></script></head><body class="dark:bg-newmo-800 text-newmo-400 dark:text-newmo-100"><div id="__next"><main class="app_container__bt_8Q"><header class="Header_header__MvnS2"><h1 class="Header_title__cchLN"><a class="Header_link__qN2Ll" href="/">ikmnjrd.github.io</a><button class="Header_darkModeButton__ayrM2" aria-label="Toggle Theme"><img width="24px" height="24px" class="DarkModeButton_icon__rb9JJ" src="/light_mode_white_24dp.svg" alt="Dark Mode Status is false" aria-hidden="true"/></button></h1><nav class="Header_nav__EE71E"><button type="button"><span class="Header_navLink__Q_hTB">Search</span></button><dialog class="modal_modal__fxCNj modal_micromodal__slide__kofBh"><div class="modal_modal__overlay__vnFmS" tabindex="-1"><div class="modal_modal__container__Id_PX" role="dialog" aria-modal="true"><div><h4 class="minisearch_title__byuz3">Search</h4><input class="minisearch_input__paOD_" value=""/><div></div><div class="minisearch_pagination__44c08"></div></div></div></div></dialog><a class="Header_navLink__Q_hTB" href="/about">About</a><a class="Header_navLink__Q_hTB" href="/tags">Tags</a></nav></header><article class="base_main__TDxIk"><h1 class="base_pageTitle__Ge5pt">JavaScript<!-- -->の投稿記事一覧</h1><div><li><a class="base_link__5Fju6" href="/blog/Next-webpack">Next.jsがWebpackを使うから嫌いという話</a></li><li><a class="base_link__5Fju6" href="/blog/chrome-dev-tool">Chromeディベロッパーツールを使おう</a></li><li><a class="base_link__5Fju6" href="/blog/consolelog-effect">cosole.logをソースコードに残しておくことのメモリへの影響について</a></li><li><a class="base_link__5Fju6" href="/blog/dataurl-markdown-contenteditable-tips">contenteditable（HTML）とdataURIを使う際のTips</a></li><li><a class="base_link__5Fju6" href="/blog/esbuild-misc">esbuildを触った際の雑記</a></li><li><a class="base_link__5Fju6" href="/blog/event-bubbling-capturing-on-react">イベントキャプチャリングとバブリング（React）</a></li><li><a class="base_link__5Fju6" href="/blog/javascript-namespace-push-me-in-pit">JavaScript名前空間でハマった話</a></li><li><a class="base_link__5Fju6" href="/blog/javascript-smartload-fs-module">CommonJSでもスマートにfsモジュールを読み込む</a></li><li><a class="base_link__5Fju6" href="/blog/javascript-summary-of-ecma-specs">歴代ECMAScript仕様情報のまとめ</a></li><li><a class="base_link__5Fju6" href="/blog/javascript-weakmap-usage">WeakMapの使い所</a></li><li><a class="base_link__5Fju6" href="/blog/javascript-why-appear-eval">疑問メモ_evalが頻出するのはなぜ</a></li><li><a class="base_link__5Fju6" href="/blog/javascript-why-var-const-togetter">疑問_なぜvarとconstが共存しているのか</a></li><li><a class="base_link__5Fju6" href="/blog/jest-within-ecma-script">疑問メモ_JestでECMAScriptを使う</a></li><li><a class="base_link__5Fju6" href="/blog/markdown-it-process">markdown-itのプラグイン開発に失敗したのでメモ</a></li><li><a class="base_link__5Fju6" href="/blog/minio-s3-express-js">AWS S3互換のMinIOにaws-sdk(client-s3)から接続する</a></li><li><a class="base_link__5Fju6" href="/blog/neovim-volta">NeoVimとvoltaを併用するとNodeを見つけてくれない問題</a></li><li><a class="base_link__5Fju6" href="/blog/nestjs-why-disable-strict">Nest.jsってなんでstrictNullChecksがデフォルトでfalseなの？</a></li><li><a class="base_link__5Fju6" href="/blog/next-sitemap-sample">Next.jsのサンプル集を参考にサイトマップを作成しようとしたらエラー</a></li><li><a class="base_link__5Fju6" href="/blog/node-package-json-keys">ESモジュール内でJSONを読み込む方法</a></li><li><a class="base_link__5Fju6" href="/blog/nuxt-auth">Nuxt.jsのAuthモジュール(@nuxtjs/auth-next)をわからないなりにざっくり解説する</a></li><li><a class="base_link__5Fju6" href="/blog/prsim-codeblock-support">忘れがちなPrismJSがサポートしている言語</a></li><li><a class="base_link__5Fju6" href="/blog/ts-jest-fail-because-import-global-jset">Jest(ts-jest)で作ったはずのmockがundefinedになるエラー</a></li><li><a class="base_link__5Fju6" href="/blog/typeorm-to-me">私が知ってるTypeORMについて、またはPrismaとの比較</a></li><li><a class="base_link__5Fju6" href="/blog/v8engine-asm-show">V8エンジン（JavaScript）が吐くアセンブリを見たい！</a></li></div></article></main><footer class="Footer_footer__UaG1g" role="contentinfo"><div class="Footer_content__Fi1S7"><ul class="Footer_socialList__RwK05"><li><a href="https://x.com/ikmnjrd" target="_blank" rel="nofollow noopener noreferrer" title="x" class="Footer_socialLink__VOPU_"><svg xmlns="http://www.w3.org/2000/svg" class="SvgIcon_icon__Uv81w" width="1.8em" height="1.8em" viewBox="0 0 1200 1227" fill="#fff"><path d="M714.163 519.284L1160.89 0H1055.03L667.137 450.887L357.328 0H0L468.492 681.821L0 1226.37H105.866L515.491 750.218L842.672 1226.37H1200L714.137 519.284H714.163ZM569.165 687.828L521.697 619.934L144.011 79.6944H306.615L611.412 515.685L658.88 583.579L1055.08 1150.3H892.476L569.165 687.854V687.828Z" fill="white"></path></svg></a></li><li><a href="https://github.com/ikmnjrd" target="_blank" rel="nofollow noopener noreferrer" title="GitHub" class="Footer_socialLink__VOPU_"><svg xmlns="http://www.w3.org/2000/svg" class="SvgIcon_icon__Uv81w" width="2em" height="2em" viewBox="0 0 24 24" fill="#fff" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg></a></li><li><a href="https://ikmnjrd.github.io/rss/feed.xml" target="_blank" rel="nofollow noopener noreferrer" title="RSS" class="Footer_socialLink__VOPU_"><svg xmlns="http://www.w3.org/2000/svg" class="SvgIcon_icon__Uv81w" width="2em" height="2em" viewBox="0 0 24 24" fill="#fff" stroke="currentColor" stroke-width="2.3" stroke-linecap="round" stroke-linejoin="round"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a></li></ul><p class="Footer_copyright__j5CNb">©︎ikmnjrd -<!-- --> <time dateTime="Sun Feb 23 2025 08:59:24 GMT+0000 (Coordinated Universal Time)">2025</time></p></div><div class="Footer_wave__VZ9GE"></div><div class="Footer_wave__VZ9GE"></div></footer></div><script id="__NEXT_DATA__" type="application/json" crossorigin="">{"props":{"pageProps":{"tag":"JavaScript","posts":[{"slug":"Next-webpack","frontmatter":{"title":"Next.jsがWebpackを使うから嫌いという話","date":"2022-02-09","tag":["webpack","Next.js","JavaScript"]},"content":"\n今まであまりrequireとimportなどの違いを意識できていない人間。\nNext.jsをプロジェクトに導入するのは賛成をとるが、個人のプロジェクトにはあまり使いたくないなーと思う程度の距離感を保っていた人間だった。現在無職。\n\nしかし、新たな職場を探すにあたってReactは使うのにNext.jsを触ったことがないというのは自分の選択肢を狭めるだけだと考え、無職期間に作り直そうとしていたRuby(Jekyll)製ブログを、Next.jsのSSGの仕組みを用いて作ることにした。（本当はメジャーバージョンがリリースされたばかりのeleventy.jsを使って作りたかった。フレームワークに求めているもの的にもeleventyの方が合っていたと今も感じる。1週間ほどはeleventy.js製のブログだった時期もある。）\n\n同リポジトリ内にマークダウンでブログ記事を上げるため、ビルド時に色々なものを生成したい要件が出てくる。Next.jsは内部でwebpackを使っていて`next.config.js`ではその一端を見ることができる。\n\n```javascript\nmodule.exports = {\n  reactStrictMode: true,\n  webpack(config, { isServer }) {\n    if (isServer) {\n      require('./scripts/generate-sitemap.js')\n    }\n  }\n}\n```\n\nwebpackはCommonJSで書かれていることは事前知識として知っていた。\n\nとは言ってもimportやexportが使いたい。`package.json`に`\"type\": \"module\"`を追加する方法などを試してみるが、最終的にproduction buildの際のfsモジュールが解決できないとか`Import trace for requested module:\n./pages/_app.js`などのエラーメッセージを残して終了していくプログラムを見るとイライラしてくる。\n\n勉強のためとはいえ、今度からNode.jsではなくDenoを使おうかなという気持ちになった。\n\n\n\n### 周辺用語\n- commonJS\n- ESModules\n- ES6(ES2015)\n\n### 参考文献\n- [Build a sitemap generator in Next.js - LogRocket Blog](https://blog.logrocket.com/build-sitemap-generator-nextjs/)\n- [Support ES module format (ESM) in next.config.js #9607](https://github.com/vercel/next.js/issues/9607)\n- [Support ES module format (ESM) in next.config.js #32239](https://github.com/vercel/next.js/discussions/32239)"},{"slug":"chrome-dev-tool","frontmatter":{"title":"Chromeディベロッパーツールを使おう","description":"ちょっと目に止まったディベロッパーツールの機能を紹介","date":"2022-09-23","tag":["Webブラウザ","JavaScript"]},"content":"\n### JavaScriptの値をリアルタイムに監視する\n![watch](https://i.gyazo.com/6672149b7ec1d9594b135a95b466d3df.png)　　\n目のマークをクリック、監視したい対象を記述する。  \n\nNext.jsのpropsなどもこのように指定することで見れる。  \n![__NEXT_DATA](https://i.gyazo.com/c0aea2fc27e14a4e81581efbdf7accc3.png)\n\n### minifyされたJSファイルを見やすくする\n巷でいうpritty printは「{}」と表示された箇所をクリック\n![minified](https://i.gyazo.com/6dc5d5259c2116dd0be1580eae2da93b.png)\n![prittyprint](https://i.gyazo.com/5f7cc0e5ce0a3abed4685a13992fd689.png)\n\n### ブレークポイント\n\n| ブレークポイントの設定できるもの | 説明 |\n|:-----------|:------------|\n| Line-of-code|\tOn an exact region of code. |\n| DOM|\tOn the code that changes or removes a specific DOM node, or its children.|\n| XHR\t|When an XHR URL contains a string pattern.|\n| Event listener|\tOn the code that runs after an event, such as click, is fired.|\n| Exception|\tOn the line of code that is throwing a caught or uncaught exception.|\n| Function\t| Whenever a specific function is called.|\n\n詳しくは[ここ](https://developer.chrome.com/docs/devtools/javascript/breakpoints/)を見てくれ\n\nDOMを右クリックして「BreakOn」から設定したり、Sourceタブの右側からXHR(Fetch)をリクエスト先を指定して設定したりできる。\n\n### console\nNode.jsで使うことの方が多いが、一応紹介\n#### console.dir\nHTML Elementを見るときなどにconsole.logだと出力してくれない情報などがあって便利\n```js\nconst obj = getElementById('hoge')\nconsole.dir(obj)\n```\n\n#### console.time\n実行時間を調べたいとき\n```js\nconsole.time();\nfor (var i = 0; i \u003c 100000; i++) {\n  let square = i ** 2;\n}\nconsole.timeEnd();\n```\n\n![console.time実行結果](https://i.gyazo.com/1e32408254a932443cfc9763d5ad213e.png)\n\n### その他一言\n#### performanceタブ\nボトルネックになっている箇所を調べるときに。パフォーマンス改善したいならとりあえず見るとこ。\n\n#### networkタブ\nAPIとのやりとりを見ようね。  \n\n飽きた。\n\n### 参考文献\n- [Watch JavaScript values in real-time with Live Expressions - Chrome Developers](https://developer.chrome.com/docs/devtools/console/live-expressions/)\n- [Pause your code with breakpoints - Chrome Developers](https://developer.chrome.com/docs/devtools/javascript/breakpoints/)\n- [Console API reference - Chrome Developers](https://developer.chrome.com/docs/devtools/console/api/)"},{"slug":"consolelog-effect","frontmatter":{"title":"cosole.logをソースコードに残しておくことのメモリへの影響について","date":"2022-01-05","tag":["JavaScript","Webブラウザ"]},"content":"\n### 疑問\nconsole.logの上書きで本番環境はデバッグメッセージを表示させないという技を知ったが、これがメモリに影響ないのかどうか知りたい。\n```javascript\nconsole.log = () =\u003e {}\n```\nちなみに最近ディベロッパーツールでメモリーのスナップショットを撮るという技を知った。\n\nCreate React Appで適当に作ったプロジェクトで適当にconsole.logを出力してみた。\n![ソース](https://i.gyazo.com/f55499b3db011a5c81d04c58d71b089b.png)\n\n`console.log`の呼び出しを増やしてブラウザを更新-\u003eHEAP Snapshot取得すると`console.log`の呼び出し回数に応じてメモリ使用量が一見増えるように見えたが、しばらく放置して再びHEAP Snapshotを取得するとメモリ使用量が低水準にまで戻る。GCに回収されたのかな？と想像したが、よくわからない。\n![メモリ](https://i.gyazo.com/1ef68f7e017d8ed2309a6ff90d9036ad.png)\n\n### 結論\nほぼ影響はない\n"},{"slug":"dataurl-markdown-contenteditable-tips","frontmatter":{"title":"contenteditable（HTML）とdataURIを使う際のTips","description":"オフライン環境でも使えるブラウザベースの簡易マークダウンエディタを作った時に知ったことのまとめ","date":"2022-08-11","tag":["HTML","JavaScript"]},"content":"## 概要\n[オフライン環境でも使えるブラウザベースの簡易マークダウンエディタ](https://github.com/ikmnjrd/browser-local-md-editor)を作成した際に知ったことなど、\n箇条書きな内容です。　　\n\n## Tips\n- `\u003cpre\u003e`と`\u003cdiv\u003e`の違い。contenteditable属性と合わせて使う場合、preは改行やスペースなど入力を入力したまま保持（入出力）してくれる が、divだと改行など特にエスケープされてしまうので、\ncontenteditableと使う場合はpreを使う方がベター\n- `\u003chead\u003e`に`\u003cstyle\u003e`タグでcssを書くとパースがシビアになりすぐ変な挙動になるので、個々のhtmlタグのstyle属性に直書きする。今回作成した簡易的なマークダウンエディタなど、\nhtmlが少ないなら有効。\n- dataURIでhtml、特にマークダウン書式を書くならマークダウンんで多用する「#」をURLエンコードに合わせることを意識しておく。#は「%23」で表現される。\n- tabキーなど、文字入力は色々気を使わなくちゃいけない。onkeydownで処理するよりonkeyupで処理した方が都合が良いことが多い。\n- contenteditableなhtmlで参考にすべきはTwitter。Twitterすごい。\n- dataURLではWebStorageが使えない。\n- dataURLではlocationAPIが使えない(Not allowed to navigate top frame to data URL)\n\n\n### 参考文献\n- [How To Add New Line In Markdown? – WiseTut](https://wisetut.com/how-to-add-new-line-in-markdown/)\n- [Data URLs](https://developer.mozilla.org/en-US/docs/Web/HTTP/Basics_of_HTTP/Data_URLs)\n- [jQueryでIME入力確定時にイベントを発行する - Qiita](https://qiita.com/hrdaya/items/6488d8dd3962cf35c0a0)"},{"slug":"esbuild-misc","frontmatter":{"title":"esbuildを触った際の雑記","description":"esbuildについての雑記","date":"2022-03-15","tag":["Node.js","JavaScript","esbuild","TypeScript"]},"content":"\nViteを使った方が楽だけど、できるだけシンプルな環境を作りたい気持ちでesbuildを触っています。\n\n\n### configファイルを作成する場合\nwatchオプションを有効にした時、ビルド情報を出力するため[logLevel](https://esbuild.github.io/api/#log-level)をinfoにすると良い。\n```javascript\n// esbuild.config.js\nconst esbuild = require('esbuild');\n\nesbuild.build({\n  logLevel: 'info',\n})\n```\n```json\n// package.json\n{\n  ...\n  \"scripts\": {\n    \"build\": \"node esbuild.config.js\",\n  }\n  ...\n}\n```\n\n\n\n### CSS Module + TypeScriptで利用したい場合\n`esbuild-css-modules-plugin`をインストールしPluginとして読み込む([GitHubリポジトリ](https://github.com/indooorsman/esbuild-css-modules-plugin))\n\n\ndeclareファイルを`src/`以下に置いておく。\n```typescript\n// index.d.ts\ndeclare module '*.css' {\n  interface IClassNames {\n    [className: string]: string\n  }\n  const classNames: IClassNames;\n  export = classNames;\n}\n```\n\n\n### 周辺用語\n- CSS modules\n- PostCSS\n\n\n### 参考文献\n- [GitHubリポジトリ - esbuild](https://github.com/evanw/esbuild)\n- [How to set up CSS Modules with esbuild](https://how-to.dev/how-to-set-up-css-modules-with-esbuild)\n- [GitHubリポジトリ - esbuild-css-modules-plugin](https://github.com/indooorsman/esbuild-css-modules-plugin))\n- [esbuild の機能が足りないならプラグインを自作すればいいじゃない](https://www.kabuku.co.jp/developers/create-your-own-esbuild-plugin)"},{"slug":"event-bubbling-capturing-on-react","frontmatter":{"title":"イベントキャプチャリングとバブリング（React）","categories":"tech","date":"2022-01-17","tag":["React","JavaScript","Webブラウザ"]},"content":"Reactはあまり関係ないです。\n\n筆者はReactからWebの世界に入ったため、Reactの世界観からWeb標準技術を見ることが多いですが、Reactのドキュメントを読んでいるとWeb標準なのかReactの世界の話なのかがよくわからないまま進んでしまいます。そんな状況だったので、JavaScriptの勉強を改めてしていたところに「Reactをやっていて出てきた言葉だけど、なんかよくわからないからスルーしたやつだ！」と再会を果たしたので記念にこの記事を書いています。\n\n### 例題\n\n```tsx\nfunction Hoge() {\n  return (\n    \u003cdiv onClick={() =\u003e console.log(\"test\")}\u003e\n      \u003cp onClick={() =\u003e console.log(\"p\")} \u003epだよ\u003c/p\u003e\n    \u003c/div\u003e\n  );\n}\n```\n作成した`\u003cp/\u003e`をクリックすると次のようになります。これが何気なく目にしている挙動と書き方だと思います。\n\n![実行結果1](https://i.gyazo.com/63f658d09ff5f2711823f9e01fc1c2a1.png)\n\n\n次に`onClickCapture`という属性からconsole.logで結果を出力してみましょう。\n\n```tsx\nfunction Hoge() {\n  return (\n    \u003cdiv onClickCapture={() =\u003e console.log(\"test\")}\u003e\n      \u003cp onClick={() =\u003e console.log(\"p\")} \u003epだよ\u003c/p\u003e\n    \u003c/div\u003e\n  );\n}\n```\n\nconsole.logで出力される順序が変わりました。\n\n![実行結果2](https://i.gyazo.com/3fb88bf4ba65dbc23410e35d38cf89d9.png)\n\nこれはWEBの標準仕様、DOMのイベントフローに基づいた仕様なのでvanillaJSであろうが、Reactであろうが元の考え方は一緒です。\n\n\n### イベントフロー\n`キャプチャリングフェーズ` 親から子へイベントを見ていく処理\n|\n`ターゲットフェーズ` 発生源の要素に到達した後、その要素自体の処理\n|\n`バブリングフェーズ` 発生源から親へイベントを見ていく段階\n参考: [https://www.w3.org/TR/DOM-Level-3-Events/#event-flow](https://www.w3.org/TR/DOM-Level-3-Events/#event-flow)\n\n### JavaScriptとReact\nJavaScriptではaddEventListenrで初心者的に何も意識せずにイベントを追加すると、バブリングフェーズでイベントが発火します。\n\nReactでも通常、ほとんどのイベントでバブリングフェーズで発火します。\n\u003e 以下のイベントハンドラはイベント伝搬のバブリングフェーズで呼び出されます。キャプチャフェーズのイベントハンドラを登録するには、イベント名に Capture を追加します。たとえば、キャプチャフェーズでクリックイベントを処理するには onClick の代わりに onClickCapture を使用します。\n\n\n### addEventListenerの第3引数（オプション）\n第3引数にあたるものは`options`、もしくは`useCapture`のプロパティです。構造上、第3引数に急にBoolean(true/false)が現れたら、useCapture属性のことです。\n以下に引用したMDNの小難しく感じる文章もそこそこ理解できるようになったのではないでしょうか。\n\n\n- options\n  - capture\n    - Boolean値で、この型のイベントがDOMツリーで下に位置するEventTargetに配信dispatchされる前に、登録されたlistenerに配信されることを示します。\n  - once\n    - Boolean値で、listenerの呼び出しを一回のみのとしたいかどうかを値で指定します。trueを指定すると、listenerは一度実行された時に自動的に削除されます。\n- useCapture\n  - Boolean値で、この型のイベントが、DOMツリー内の下のEventTargetに配信される前に、登録されたlistenerに配信されるかどうかを示します。ツリーを上方向にバブリングしているイベントは、キャプチャーを使用するように指定されたリスナーを起動しません。イベントのバブリングとキャプチャーは、両方の要素がそのイベントのハンドラーを登録している場合に、別の要素内に入れ子になっている要素で発生するイベントを伝播する2つの方法です。イベント伝播モードは、要素がイベントを受け取る順番を決定します。詳細な説明は DOM Level 3 Events と JavaScript Event order を参照してください。指定されていない場合、useCaptureは既定でfalseとなります。\n\n\n### 参考\n- [https://uhyohyo.net/javascript/3_4.html](https://uhyohyo.net/javascript/3_4.html)\n- [https://developer.mozilla.org/ja/docs/Web/API/EventTarget/addEventListener](https://developer.mozilla.org/ja/docs/Web/API/EventTarget/addEventListener)\n- [https://ja.reactjs.org/docs/events.html](https://ja.reactjs.org/docs/events.html)\n- [https://ja.reactjs.org/blog/2020/08/10/react-v17-rc.html#no-event-pooling](https://ja.reactjs.org/blog/2020/08/10/react-v17-rc.html#no-event-pooling)\n"},{"slug":"javascript-namespace-push-me-in-pit","frontmatter":{"title":"JavaScript名前空間でハマった話","date":"2021-12-30","tag":["JavaScript"]},"content":"\nハマったポイントとその解決策を書く。\n\n### ハマったポイント\n\nなぜ②の箇所で変数`audio`にアクセスできてしまうの？？？？\n\n```javascript\nconst init = () =\u003e {\n\n  const upload_file = document.getElementById('uploadedFile');\n  const audio = document.getElementById('audio');\n\n  upload_file.addEventListener('change', (e) =\u003e {\n    audio.src = URL.createObjectURL(e.target.files[0]);\n\n    console.log(audio); // ①\n    audio.load();\n    audio.play();\n    draw();\n  });\n}\n\nconst draw = () =\u003e {\n  console.log(audio); // ②\n}\n\nwindow.onload = init();\n\n```\n\noutput例\n```html\n\u003caudio id=\"audio\" controls=\"\" src=\"blob:http://localhost:8080/b691c70c-4570-4659-97d3-45577d80ec21\"\u003e\u003c/audio\u003e\n\u003caudio id=\"audio\" controls=\"\" src=\"blob:http://localhost:8080/b691c70c-4570-4659-97d3-45577d80ec21\"\u003e\u003c/audio\u003e\n```\n\n\n### 起こっていたこと\nググったらすぐに出てきた。\n\u003e タイトルの通りなんですが, HTML の DOM に指定した id はすべて同じ変数名としてグローバル変数に格納されます.\n参考: [https://zenn.dev/phi/articles/javascript-tips-dom-id-global](https://zenn.dev/phi/articles/javascript-tips-dom-id-global)\n\n\n```javascript\nconst init = () =\u003e {\n\n  const upload_file = document.getElementById('uploadedFile');\n  const audio2 = document.getElementById('audio');\n\n  upload_file.addEventListener('change', (e) =\u003e {\n    audio2.src = URL.createObjectURL(e.target.files[0]);\n\n    console.log(audio); // ①\n    audio2.load();\n    audio2.play();\n    draw();\n  });\n}\n\nconst draw = () =\u003e {\n  console.log(audio);\n  console.log(audio2); // ②\n}\n\nwindow.onload = init();\n```\noutput例\n```jsstacktrace\nscript.js:40 \u003caudio id=​\"audio\" controls src=​\"blob:​http:​/​/​localhost:​8080/​b337de48-6ba2-459b-a022-d56dae3da9d3\"\u003e​…​\u003c/audio\u003e​\nscript.js:41 Uncaught ReferenceError: audio2 is not defined\n    at draw (script.js:41)\n    at HTMLInputElement.\u003canonymous\u003e (script.js:30)\ndraw @ script.js:41\n```\n\n\n\n### 解決案\n\nidは慎重に名付けしよう。\n\n\n### 周辺用語\n- グローバル変数\n- DOM\n\n\n### 参考文献\n- [https://zenn.dev/phi/articles/javascript-tips-dom-id-global](https://zenn.dev/phi/articles/javascript-tips-dom-id-global)\n"},{"slug":"javascript-smartload-fs-module","frontmatter":{"title":"CommonJSでもスマートにfsモジュールを読み込む","date":"2022-02-03","tag":["JavaScript"]},"content":"### 前提\nNode.jsで開発するとき、`fs`はかなりよく使う。\nそして私はまだwebpackの呪縛から逃れられていないので、CommonJSで書きたい場面が多い。\nそして現在で使うときは大抵`Promise型`で使う。\n\n### 結論\nそんなときには次のように書くとスマート\n```javascript\nconst { promises: fs } = require('fs')\n```\n\nこういう書き方でもいい。\n```javascript\nconst fs = require('fs').promises;\n```\n\n\n### 参考文献\n- [https://github.com/vercel/next.js/blob/canary/examples/blog/scripts/gen-rss.js](https://github.com/vercel/next.js/blob/canary/examples/blog/scripts/gen-rss.js)\n- [[Node.js]fs.promises APIの使い方](https://tech.chakapoko.com/nodejs/file/promises.html)\n"},{"slug":"javascript-summary-of-ecma-specs","frontmatter":{"title":"歴代ECMAScript仕様情報のまとめ","date":"2022-01-16","tag":["JavaScript"]},"content":"\n### まとめ\nここを見ろ\n- [https://developer.mozilla.org/ja/docs/Web/JavaScript/Language_Resources](https://developer.mozilla.org/ja/docs/Web/JavaScript/Language_Resources)\n\nGitHubリポジトリや公式ページは過去の仕様が見辛い\n- [https://github.com/tc39/ecma262](https://github.com/tc39/ecma262)\n- [https://tc39.es/](https://tc39.es/)\n"},{"slug":"javascript-weakmap-usage","frontmatter":{"title":"WeakMapの使い所","date":"2022-01-16","tag":["JavaScript"]},"content":"\n### WeakMapとは\nES2015で追加された仕様。ハッシュテーブルの一種。\nMDNには以下のように書かれています。\n\u003eThe WeakMap object is a collection of key/value pairs in which the keys are weakly referenced.\n\n`weakly referenced keys`(弱い参照) という概念がキモ。\n\n\n似たオブジェクトとの一番わかりやすい違いが、キーにすることができるデータ型です。\n| オブジェクト | プロパティキーにできるもの | 値にできるもの |\n|:-----------|:------------|:------------|\n| WeakMap   | Object      | 任意            |\n| Object    | 文字列, Symbol    | 任意       |\n| Map       | 関数、オブジェクト、あらゆるプリミティブなど    | 任意      |\n\nちなみにArray型（配列）は、キーバリューのかたち（キー付きコレクション）ではないです。逆にArrayやInt8Arrayなどは索引付きコレクションと呼ばれています。[参考:「標準組み込みオブジェクト」](https://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Global_Objects)\n\n上の表を見た個人的感想はWeakMapはObjectと似ているな、と思うので今回の比較に用いていきたいと思います。\n\n### Objectとの違い、使い分け\n\n雑な説明ですが、JavaScriptではプロトタイプチェーンの仕組みにより、新しいオブジェクトを作ると元にしたオブジェクトを参照しながらメモリに保持されます。\n\n\u003e キーによるオブジェクト参照は弱く保持され、そのオブジェクトへの参照が他に存在しないときはガベージコレクション (GC) の対象になります\n\u003e \u003ccite\u003e出典: [MDN-キー付きコレクション](https://developer.mozilla.org/ja/docs/Web/JavaScript/Guide/Keyed_collections#weakmap_object)\u003c/cite\u003e\n\nこれが\"弱い参照\"とされる理由の一つです。\n\u003e Map オブジェクトとの違いの１つは、WeakMap のキーは列挙可能ではないことです（すなわち、キーのリストを取得するメソッドがありません）。もしも列挙可能であれば、リストは非決定性をもたらす、ガベージコレクションの状態に依存することになってしまいます。\n\u003e \u003ccite\u003e出典: [MDN-キー付きコレクション](https://developer.mozilla.org/ja/docs/Web/JavaScript/Guide/Keyed_collections#weakmap_object)\u003c/cite\u003e\n\n\n\n### 使い方の例\n\n```javascript\n  // HTMLMediaElement用\n  var audioEle;\n  var wm = new WeakMap();\n\n  /* 〜中略〜 */\n\n  // WeakMapでHTMLMediaElementを保持する\n  if (wm.has(audioEle)) {\n    audioSourceNode = wm.get(audioEle);\n  } else {\n    audioSourceNode = audioCtx.createMediaElementSource(audioEle);\n    wm.set(audioEle, audioSourceNode);\n  }\n```\n出典:[https://github.com/TakeshiOkamoto/waveform-spectrum/blob/master/waveform-spectrum.js](https://github.com/TakeshiOkamoto/waveform-spectrum/blob/master/waveform-spectrum.js)\n\n### 参考\n- [WeakMap Objects-sec](https://262.ecma-international.org/#sec-weakmap-objects)\n- [tc39-GitHub](https://github.com/tc39/ecma262-6-src)\n- [MDN](https://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Global_Objects/WeakMap)\n- [https://uhyohyo.net/javascript/16_1.html](https://uhyohyo.net/javascript/16_1.html)\n- [https://github.com/TakeshiOkamoto/waveform-spectrum/blob/master/waveform-spectrum.js](https://github.com/TakeshiOkamoto/waveform-spectrum/blob/master/waveform-spectrum.js)\n"},{"slug":"javascript-why-appear-eval","frontmatter":{"title":"疑問メモ_evalが頻出するのはなぜ","date":"2021-12-26","tag":["JavaScript"]},"content":"\n### 疑問\nなんでWebpack?esbuild?などでトランスパイルしたjsファイルにeval(withも?みたことはないけど)が頻出するの？\nMDNを見たけど、危険ってことしかわからなかった。\n自分なりに考えた理由としてはevalは機械語(ネイティブコード)に近いからコンパイルが楽になると予想した。\n\n### 自分なりの回答\n`eval`は[標準組み込みオブジェクト](https://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Global_Objects)として実装されているから、と言う説\n\n### 周辺用語\n- \n\n\n### 参考文献\n- [標準組み込みオブジェクト](https://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Global_Objects)\n"},{"slug":"javascript-why-var-const-togetter","frontmatter":{"title":"疑問_なぜvarとconstが共存しているのか","date":"2022-01-23","tag":["JavaScript","Next.js","Node.js"]},"content":"### 疑問に遭遇した状況\nNext.jsで`$ next export`が気になり、`~/node_modules/next/dist/cli/next-export.js`を見ていた。\n\n### 疑問\nグローバル宣言している`var`とES2015(ES6)から追加された`const`と`let`が共存している。なぜ？？\n\n```javascript\n#!/usr/bin/env node\n\"use strict\";\nObject.defineProperty(exports, \"__esModule\", {\n    value: true\n});\nexports.nextExport = void 0;\nvar _path = require(\"path\");\nvar _fs = require(\"fs\");\nvar _indexJs = _interopRequireDefault(require(\"next/dist/compiled/arg/index.js\"));\nvar _export = _interopRequireDefault(require(\"../export\"));\nvar _utils = require(\"../server/lib/utils\");\nvar _trace = require(\"../trace\");\nvar _isError = _interopRequireDefault(require(\"../lib/is-error\"));\nvar _getProjectDir = require(\"../lib/get-project-dir\");\nfunction _interopRequireDefault(obj) {\n    return obj \u0026\u0026 obj.__esModule ? obj : {\n        default: obj\n    };\n}\nconst nextExport = (argv)=\u003e{\n    const nextExportCliSpan = (0, _trace).trace('next-export-cli');\n    const validArgs = {\n        // Types\n        '--help': Boolean,\n        '--silent': Boolean,\n        '--outdir': String,\n        '--threads': Number,\n        // Aliases\n        '-h': '--help',\n        '-s': '--silent',\n        '-o': '--outdir'\n    };\n    let args;\n    try {\n        args = (0, _indexJs).default(validArgs, {\n            argv\n        });\n    } catch (error) {\n        if ((0, _isError).default(error) \u0026\u0026 error.code === 'ARG_UNKNOWN_OPTION') {\n            return (0, _utils).printAndExit(error.message, 1);\n        }\n        throw error;\n    }\n    if (args['--help']) {\n        console.log(`\n      Description\n        Exports the application for production deployment\n\n      Usage\n        $ next export [options] \u003cdir\u003e\n\n      \u003cdir\u003e represents the directory of the Next.js application.\n      If no directory is provided, the current directory will be used.\n\n      Options\n        -h - list this help\n        -o - set the output dir (defaults to 'out')\n        -s - do not print any messages to console\n    `);\n        process.exit(0);\n    }\n    const dir = (0, _getProjectDir).getProjectDir(args._[0]);\n    // Check if pages dir exists and warn if not\n    if (!(0, _fs).existsSync(dir)) {\n        (0, _utils).printAndExit(`\u003e No such directory exists as the project root: ${dir}`);\n    }\n    const options = {\n        silent: args['--silent'] || false,\n        threads: args['--threads'],\n        outdir: args['--outdir'] ? (0, _path).resolve(args['--outdir']) : (0, _path).join(dir, 'out')\n    };\n    (0, _export).default(dir, options, nextExportCliSpan).then(()=\u003e{\n        nextExportCliSpan.stop();\n        (0, _utils).printAndExit(`Export successful. Files written to ${options.outdir}`, 0);\n    }).catch((err)=\u003e{\n        nextExportCliSpan.stop();\n        (0, _utils).printAndExit(err);\n    });\n};\nexports.nextExport = nextExport;\n\n//# sourceMappingURL=next-export.js.map\n```\n\n### 周辺用語\n- Next.js\n- ESModules\n- CommonJS\n\n\n### 参考文献\n- [MDN - Object.defineProperty()](https://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Global_Objects/Object/defineProperty)\n- [javascript.info - モジュール, 導入](https://ja.javascript.info/modules-intro)\n"},{"slug":"jest-within-ecma-script","frontmatter":{"title":"疑問メモ_JestでECMAScriptを使う","date":"2022-01-07","tag":["Jest","JavaScript"]},"content":"\n### 疑問\nJestでECMAScriptを使う方法が[公式](https://jestjs.io/ja/docs/ecmascript-modules)に書いてある。\nやってみたけどなぜかできなかったというメモ。\n\n公式通りにやってみた結果以下のエラー。\n\n### エラー全文\n```bash\n% node --experimental-vm-modules node_modules/jest/bin/jest.js\n(node:92238) ExperimentalWarning: VM Modules is an experimental feature. This feature could change at any time\n(Use `node --trace-warnings ...` to show where the warning was created)\n FAIL  ./index.test.js\n  ● Test suite failed to run\n\n    Jest encountered an unexpected token\n\n    Jest failed to parse a file. This happens e.g. when your code or its dependencies use non-standard JavaScript syntax, or when Jest is not configured to support such syntax.\n\n    Out of the box Jest supports Babel, which will be used to transform your files into valid JS based on your Babel configuration.\n\n    By default \"node_modules\" folder is ignored by transformers.\n\n    Here's what you can do:\n     • If you are trying to use ECMAScript Modules, see https://jestjs.io/docs/ecmascript-modules for how to enable it.\n     • If you are trying to use TypeScript, see https://jestjs.io/docs/getting-started#using-typescript\n     • To have some of your \"node_modules\" files transformed, you can specify a custom \"transformIgnorePatterns\" in your config.\n     • If you need a custom transformation specify a \"transform\" option in your config.\n     • If you simply want to mock your non-JS modules (e.g. binary assets) you can stub them out with the \"moduleNameMapper\" config option.\n\n    You'll find more details and examples of these config options in the docs:\n    https://jestjs.io/docs/configuration\n    For information about custom transformations, see:\n    https://jestjs.io/docs/code-transformation\n\n    Details:\n\n    /Users/ike/workspace/no-degradation-image-converter/index.test.js:1\n    ({\"Object.\u003canonymous\u003e\":function(module,exports,require,__dirname,__filename,jest){import sum from './index';\n                                                                                      ^^^^^^\n\n    SyntaxError: Cannot use import statement outside a module\n\n      at Runtime.createScriptFromCode (node_modules/jest-runtime/build/index.js:1728:14)\n      at TestScheduler.scheduleTests (node_modules/@jest/core/build/TestScheduler.js:333:13)\n\nTest Suites: 1 failed, 1 total\nTests:       0 total\nSnapshots:   0 total\nTime:        0.222 s\n```\n\n### わからないことを辿る\nそもそも実行時に付与してるオプションは、[Node.js]((https://nodejs.org/api/cli.html#--experimental-vm-modules))のサイトでこのように説明されている。\n\u003e--experimental-vm-module\n\u003eEnable experimental ES Module support in the vm module.\n\nとてもあっさり！\n\n`vm module`とはなんぞ？\n要はV8エンジンらしい。以下公式での[Node.jsのサイト](https://nodejs.org/api/vm.html#vm-executing-javascript)での説明\n\u003eThe vm module enables compiling and running code within V8 Virtual Machine contexts. The vm module is not a security mechanism. Do not use it to run untrusted code.\n\nそして迷宮入り。Nodeを16の最新安定版にしてみたけどダメでしたね。\n大人しくCommonJSでrequireします。\n\n\n### 周辺用語\n- Node.js\n- V8\n- VM moduel\n- CommonJS\n- ECMAScript\n\n\n### 参考文献\n- [--experimental-vm-module](https://nodejs.org/api/cli.html#--experimental-vm-modules)\n- [(https://nodejs.org/api/vm.html#vm-executing-javascript)](https://nodejs.org/api/vm.html#vm-executing-javascript)\n- [https://nodejs.org/api/vm.html#vm-executing-javascript](https://nodejs.org/api/vm.html#vm-executing-javascript)\n"},{"slug":"markdown-it-process","frontmatter":{"title":"markdown-itのプラグイン開発に失敗したのでメモ","date":"2022-08-07","tag":["JavaScript","Node.js"]},"content":"\n失敗したけど、悔しいので調べたことのメモとそのプラグインの[リポジトリ](https://github.com/ikmnjrd/markdown-it-bqcite)\n作ろうとした機能は、`\u003cblockquote/\u003e` 内の特定prefixから始まる箇所を`\u003ccite/\u003e`で囲もうとういうもの。\n\n```md\n\u003e 内容はこれ\n\u003e --- 出典はこれ\n```\nこんなのを\n\n\u003e 内容はこれ\n\u003e \u003ccite\u003e出典はこれ\u003c/cite\u003e\n\nこんな風に出力したかった\n\n### markdown-itの処理の大きな流れ\n1. ソース(.md)をToken単位にまずparse。この際、inlineやblockといった固まりで放置されるものがある。\n2. 1.でparseしたものをStringとして出力しながらinlineやblockで放置されたものをそれぞれのルールに従いながらパース。パースしながら出力\n\n\n### 流れ\nMarkdownIt#render(src)\n\nMarkdownIt#parse(src)\n\nstate = new this.core.State(src, this, env);\n// Tokenクラスの読み込み初期化など\n\nthis.core.process(state)\n// coreルールを順にstateを引き回しながら実行\n// stateをToken[]にparse終了\n\n\nMarkdownIt#renderer#renderを実行。token.typeがinlineならRenderer#renderInlineを実行。独自ルールのあるtoken.typeならそのルールを実行。どちらにも当てはまらないならRenderer#renderTokenを実行\n```js\nRenderer.prototype.render = function (tokens, options, env) {\n  var i, len, type,\n      result = '',\n      rules = this.rules;\n\n  for (i = 0, len = tokens.length; i \u003c len; i++) {\n    type = tokens[i].type;\n\n    if (type === 'inline') {\n      result += this.renderInline(tokens[i].children, options, env);\n    } else if (typeof rules[type] !== 'undefined') {\n      result += rules[type](tokens, i, options, env, this);\n    } else {\n      result += this.renderToken(tokens, i, options, env);\n    }\n  }\n\n  return result;\n};\n```\n\nRenderer#renderInlinの処理例\n\n\nRenderer#renderTokenの処理例\nToken.hiddenなら空文字を返す\n\n\nouTokensに追加?意味わからん\n\n\n\n### テストに使ってた.md\n```md\n\u003e this\n\u003e is\n\u003e test\n\u003e --- in-cite\n\n\u003c!-- \u003e\u003e\u003e second\n--- in-cite --\u003e\n\n\n\u003c!-- \u003e\u003e\u003e aaa\nbbb\nccc --\u003e\n\n\u003e `hoge`\n\u003e hoge\n\n\u003e link in cite\n\u003e --- [link](https://github.com/markdown-it/markdown-it/blob/master/lib/renderer.js)\n```"},{"slug":"minio-s3-express-js","frontmatter":{"title":"AWS S3互換のMinIOにaws-sdk(client-s3)から接続する","description":"@aws-sdk/client-s3を利用したMinIOへの接続例のサンプルコード","date":"2022-12-08","tag":["JavaScript","Express.js","AWS"]},"content":"### 結論\ns3-clientでMinIOに繋げる！\n\n### 状況\nローカルで完結する開発環境でもS3にできるだけ近い形をとりたかった。  \n[MinIO](https://min.io/)というS3互換のオブジェクトストレージが無料らしいので使ってみる。\n\n\n### MinIO導入\n以下のようなディレクトリ構造とする。\n```sh\n.\n├── docker\n│   └── minio\n│       └── data\n├── docker-compose.yml\n```\n```yml\nversion: '3.8'\nservices:\n  minio:\n    image: minio/minio:RELEASE.2022-11-29T23-40-49Z\n    ports:\n      - 9000:9000\n      - 9090:9090\n    environment:\n      - MINIO_ROOT_USER=minio\n      - MINIO_ROOT_PASSWORD=miniopass\n      - MINIO_VOLUMES=/data\n    entrypoint: sh\n    command: -c \"\n      minio server --console-address ':9090'\"\n    volumes:\n      - ./docker/minio/data:/data\n```\n\nコンテナを起動するとlocalhost:9090でminioの管理画面が表示される。\n\n\n### aws-sdkでMinIOに接続する\n`s3.js`\n```js\nimport { S3Client, PutObjectCommand } from '@aws-sdk/client-s3'\n\nconst IS_DEV = process.env.IS_DEV\nconst AWS_S3_REGION = process.env.AWS_S3_REGION\nconst AWS_ACCESS_KEY_ID = process.env.AWS_ACCESS_KEY_ID\nconst AWS_SECRET_ACCESS_KEY = process.env.AWS_SECRET_ACCESS_KEY\nconst AWS_S3_BUCKET_NAME = process.env.AWS_S3_BUCKET_NAME\n\n\nconst s3client = new S3Client(\n  IS_DEV\n    ? {\n        region: AWS_S3_REGION,\n        credentials: {\n          accessKeyId: 'minio', // MINIO_ROOT_USER\n          secretAccessKey: 'miniopass' // MINIO_ROOT_PASSWORD\n        },\n        endpoint: 'http://localhost:9000/',\n        forcePathStyle: true\n      }\n    : {\n        region: AWS_S3_REGION,\n        credentials: {\n          accessKeyId: AWS_ACCESS_KEY_ID,\n          secretAccessKey: AWS_SECRET_ACCESS_KEY\n        }\n      }\n)\nexport const uploadToS3 = async (body) =\u003e {\n  try {\n    const data = await s3client.send(\n      new PutObjectCommand({\n        Bucket: AWS_S3_BUCKET_NAME,\n        Key: 'test/key.png',\n        Body: body,\n      })\n    )\n    console.debug('Success', data)\n    return\n  } catch (err) {\n    console.error('Error', err)\n    throw err\n  }\n}\n\n```\n\n`index.js`\n```js\nimport express, { Router } from 'express'\nimport { uploadToS3 } from './s3'\n\nconst app = express()\nconst router = Router()\n\nrouter.post('/image/upload', async (req, res) =\u003e {\n    // 最小のpng\n    const reqBodyMock = 'iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAAAAAA6fptVAAAACklEQVQIHWP4DwABAQEANl9ngAAAAABJRU5ErkJggg=='\n\n    await uploadToS3(reqBodyMock)\n\n    return res.status(201)\n  }\n)\n\napp.use(router)\napp.listen('3000')\n```\n\n### multerS3でクライアントのフォームから送信された画像を保存する\n\n`multer.js`\n```js\nimport multer from 'multer'\nimport multerS3 from 'multer-s3'\nimport { s3client } from './s3'\n\nexport const multerUpload = multer({\n  storage: multerS3({\n    s3: s3client,\n    bucket: AWS_S3_BUCKET_NAME,\n    metadata: (_req, file, cb) =\u003e {\n      cb(null, { fieldName: file.fieldname })\n    },\n    key: (_req, file, cb) =\u003e {\n      cb(null, file.originalname)\n    }\n  })\n})\n```\n\n`index.js`\n```js\nimport express, { Router } from 'express'\nimport { uploadToS3 } from './s3'\nimport { multerUpload } from './multer'\n\nconst app = express()\nconst router = Router()\n\nrouter.post(\n  '/image/upload',\n  multerUpload.single(),\n  async (req, res) =\u003e {\n    const file = req.file // 色々都合のいいファイル（本例だとimage/pngだったり的な）\n\n    // s3multerでポート番号が削られてしまうので無理やりつける。\n    const fileLocation = IS_DEV\n      ? file.location.replace(\n          /^http:\\/\\/localhost/,\n          'http://localhost:9000'\n        )\n      : file.location\n\n    return res.status(200).json({location: fileLocation})\n  }\n)\n\napp.use(router)\napp.listen('3000')\n```\n\n### 参考文献\n- [ローカルS3環境(minio)を構築する - Qiita](https://qiita.com/reflet/items/3e0f07bc9d64314515c1)\n- [最小のpng画像](https://yosiopp.net/archives/225/)\n\n### 関連用語\n- busboy\n- multer\n- multerS3\n"},{"slug":"neovim-volta","frontmatter":{"title":"NeoVimとvoltaを併用するとNodeを見つけてくれない問題","description":"NeoVimとvoltaを使うと必ずこの問題にぶち当たるのでは？","date":"2022-10-13","tag":["Node.js","NeoVim","JavaScript","volta"]},"content":"\n## 環境\n\n| 関連ソフトウェア | バージョン |\n|:--------------|:---------|\n| macOS         | 12.6     |\n| NodeJS        | 16.17.0  |\n| volta         | 1.0.8    |\n| NeoVim        | 8.0      |\n\n\n## 結論\nvoltaを使うなら[voltaのIssue](https://github.com/volta-cli/volta/issues/866)にあるようにinit.vimに以下のような記述をしておく。\n\n```vim\nif executable('volta')\n  let g:node_host_prog = trim(system(\"volta which neovim-node-host\"))\nendif\n```\n\n## 経緯とシューティングタイムライン\n仕事でNeoVimは一切使っていないのですが、休日趣味的に開いてみたらなんか様子がおかしい。\n\nNeoVimを開いて`:checkhealth provider`を入力すると、以下のようなメッセージ。\n\n```markdown\nprovider: health#provider#check\n========================================================================\n\n## Node.js provider (optional)\n  - INFO: Node.js: v16.17.0\n  - WARNING: Missing \"neovim\" npm (or yarn, pnpm) package.\n    - ADVICE:\n      - Run in shell: npm install -g neovim\n      - Run in shell (if you use yarn): yarn global add neovim\n      - Run in shell (if you use pnpm): pnpm install -g neovim\n      - You may disable this provider (and warning) by adding `let g:loaded_node_provider = 0` to your init.vim\n\n```\n\n`npm install -g neovim`もしくは`volta install neovim`をしても変わらない。  \nここで[公式のHelp](https://neovim.io/doc/user/provider.html)を読むと、  \n\n\u003e By default, Nvim searches for \"neovim-node-host\" using \"npm root -g\", which can be slow. To avoid this, set g:node_host_prog to the host path: \u003ccite\u003e[Provider - Neovim docs](https://neovim.io/doc/user/provider.html)\u003c/cite\u003e\n\n自分のvoltaを使ってる環境で`npm root -g`を実行すると以下のような結果に。\n```sh\n/Users/ike/.volta/tools/image/node/16.17.0/lib/node_modules\n```\n\nということで、`g:node_host_prog`オプションを設定したいが、うまくいかん。  \nそもそもvoltaを使ってグローバルインストールしたパッケージは`/Users/ike/.volta/bin/volta-shim`にshimとしてインストールされ、シンボリックリンクが貼られる形をとっている。  \nこんな感じ  \n```sh\n% ls -al ~/.volta/bin\ndrwxr-xr-x  12 ike  staff      384 Oct 13 16:45 .\ndrwxr-xr-x   9 ike  staff      288 Sep 10 23:29 ..\nlrwxr-xr-x   1 ike  staff       32 Sep 21 21:34 http-server -\u003e /Users/ike/.volta/bin/volta-shim\nlrwxr-xr-x   1 ike  staff       32 Sep 15 23:36 memlab -\u003e /Users/ike/.volta/bin/volta-shim\nlrwxr-xr-x   1 ike  staff       32 Oct 13 16:45 neovim-node-host -\u003e /Users/ike/.volta/bin/volta-shim\nlrwxr-xr-x   1 ike  staff       32 Sep 10 23:29 node -\u003e /Users/ike/.volta/bin/volta-shim\nlrwxr-xr-x   1 ike  staff       32 Sep 10 23:29 npm -\u003e /Users/ike/.volta/bin/volta-shim\nlrwxr-xr-x   1 ike  staff       32 Sep 10 23:29 npx -\u003e /Users/ike/.volta/bin/volta-shim\n-rwxr-xr-x   1 ike  staff  6522504 Jun  2 09:14 volta\n-rwxr-xr-x   1 ike  staff  4771376 Jun  2 09:14 volta-migrate\n-rwxr-xr-x   1 ike  staff  5522480 Jun  2 09:14 volta-shim\nlrwxr-xr-x   1 ike  staff       32 Sep 10 23:29 yarn -\u003e /Users/ike/.volta/bin/volta-shim\n```\n\nわからん状態だったため、GitHubを探し、[結論](#結論)部分でも貼ったコードをコピペして終了。  \nVim(NeoVim)わからん。  \n\n### 周辺用語\n- Shim\n\n### 参考文献\n- [volta + neovim compatibility issues · Issue #866 · volta-cli/volta](https://github.com/volta-cli/volta/issues/866)\n- [Understanding Volta | Volta](https://docs.volta.sh/guide/understanding#managing-your-toolchain)\n- [Provider - Neovim docs](https://neovim.io/doc/user/provider.html)\n- [Shim と Polyfill](https://qiita.com/ybiquitous/items/3104beb84b78ca15f407)"},{"slug":"nestjs-why-disable-strict","frontmatter":{"title":"Nest.jsってなんでstrictNullChecksがデフォルトでfalseなの？","description":"Nest.jsが採用された炎上案件に放り込まれた時の疑問の備忘録","date":"2023-08-07","tag":["Nest.js","JavaScript"]},"content":"\n### TL;DR\nNest.jsのインストールを公式ドキュメントに何も考えずに沿っていくと、TypeScriptユーザーが怒りそうな設定が放り込まれたtsconfigができあがってる。\n\n\n### 疑問に遭遇した状況\nAPIサーバーにNest.jsを採用したプロジェクトに途中参加した時、「型からnullが落ちるなー」と思っていた。  \n私はNest.jsも初めてで、TypeORMなど他にも初めてのフレームワークだらけだったので、ここら辺の設計思想かな？と逡巡したが、普通にtsconfigでstrictNullChecksがfalseになっていて愕然とした。\n\n### なんでstrictNullChecksがfalseになるの？\n[公式のGetting Started](https://docs.nestjs.com/)をただなぞっていくと、以下のような`tsconfig.json`ができる...\n```json\n{\n  \"compilerOptions\": {\n    ...\n    \"strictNullChecks\": false,\n    \"noImplicitAny\": false,\n    \"strictBindCallApply\": false,\n    \"forceConsistentCasingInFileNames\": false,\n    \"noFallthroughCasesInSwitch\": false\n  }\n}\n```\n\nこの件に不服を唱えたユーザーがいたが、Nest.js開発メンバー(@kamilmysliwiec)は以下のように返答を寄せている。(DeepL翻訳)\n\n\u003e 物事を可能な限り型安全にすることが一般的に望ましいということには同意しますが、strictNullCheck/noImplictAnyをtrueに設定すると学習曲線が険しくなることを念頭に置かなければなりません。適切なバランスを追求するのは常に難しい(中略)\n\u003e 幸い、これは差し迫った問題ではないように思える。誰かがこのオプションを使いたいのであれば、オンにすればいい。今のところ、このオプションをデフォルトにする予定はないが、時間の経過とともに変更されるかもしれない。\n\u003e \u003ccite\u003e出典: [Please turn on `strictNullChecks` option to be `true` · Issue #2057 · nestjs/nest-cli](https://github.com/nestjs/nest-cli/issues/2057#issuecomment-1549083356)\u003c/cite\u003e\n\n\n`--strict`オプションを使うと次のようにTSユーザーが慣れ親しんでるような設定になる。\n\n```json\n{\n  \"compilerOptions\": {\n    ...\n    \"skipLibCheck\": true,\n    \"strictNullChecks\": true,\n    \"noImplicitAny\": true,\n    \"strictBindCallApply\": true,\n    \"forceConsistentCasingInFileNames\": true,\n    \"noFallthroughCasesInSwitch\": true\n  }\n}\n\n```\n\n`--strict`オプションを使ったり、開発初期にしっかりとtsconfigを見直そう。私と同じ状況になった人はブチギレながらtsconfigを設定し直した後に修正を入れまくろう。\n\n\n### 参考文献\n- [Please turn on `strictNullChecks` option to be `true` · Issue #2057 · nestjs/nest-cli](https://github.com/nestjs/nest-cli/issues/2057#issuecomment-1549083356)\n- [Documentation | NestJS - A progressive Node.js framework](https://docs.nestjs.com/)"},{"slug":"next-sitemap-sample","frontmatter":{"title":"Next.jsのサンプル集を参考にサイトマップを作成しようとしたらエラー","date":"2022-02-08","tag":["Node.js","Next.js","JavaScript"]},"content":"エラーに遭遇しました。\n\n### 環境\n- Node: v16.13.2\n- Next.js: 12.0.10\n- globby: 13.1.1\n\n[公式のサンプル集の「with-sitemap」](https://github.com/vercel/next.js/tree/canary/examples/with-sitemap)では以下のようなスクリプトをサーバー実行時に（`next.config.js`のisServerオブションをフラグにして）実行している。\n\n\n./scripts/generate-sitemap.js\n```javascript\nconst fs = require('fs')\nconst globby = require('globby')\n\nfunction addPage(page) {\n  const path = page.replace('pages', '').replace('.js', '').replace('.mdx', '')\n  const route = path === '/index' ? '' : path\n\n  return `  \u003curl\u003e\n    \u003cloc\u003e${`${process.env.WEBSITE_URL}${route}`}\u003c/loc\u003e\n    \u003cchangefreq\u003ehourly\u003c/changefreq\u003e\n  \u003c/url\u003e`\n}\n\nasync function generateSitemap() {\n  // Ignore Next.js specific files (e.g., _app.js) and API routes.\n  const pages = await globby([\n    'pages/**/*{.js,.mdx}',\n    '!pages/_*.js',\n    '!pages/api',\n  ])\n  const sitemap = `\u003curlset xmlns=\"http://www.sitemaps.org/schemas/sitemap/0.9\"\u003e\n${pages.map(addPage).join('\\n')}\n\u003c/urlset\u003e`\n\n  fs.writeFileSync('public/sitemap.xml', sitemap)\n}\n\ngenerateSitemap()\n\n```\n\n\n遭遇したエラーは以下\n\n```bash\nError [ERR_REQUIRE_ESM]: require() of ES Module ./node_modules/globby/index.js from ./scripts/generate-sitemap.js not supported.\nInstead change the require of index.js in ./scripts/generate-sitemap.js to a dynamic import() which is available in all CommonJS modules.\n```\n\n最新のglobbyからはCommonJSが省かれたらしい。\n\n\n### 解決策\npackage.jsonを以下のように書き換え、`$npm i`を実行\n```json\n\"globby\": \"^13.1.1\",\n```\n↓\n```json\n\"globby\": \"^11.0.1\",\n```\n\nインストール後、ビルド時に`./public/sitemap.xml`が無事出力された。\n\n\n### 周辺用語\n- commonJS\n- ESModules\n\n\n### 参考文献\n- [Build a sitemap generator in Next.js - LogRocket Blog](https://blog.logrocket.com/build-sitemap-generator-nextjs/)"},{"slug":"node-package-json-keys","frontmatter":{"title":"ESモジュール内でJSONを読み込む方法","description":"ESモジュール内でJSONを読み込む方法","date":"2022-08-06","tag":["Node.js","JavaScript","JSON"]},"content":"\n### 楽ができるNodeのバージョン\nNode.js`v17.5~`もしくは`v16`の`--experimental-json-modules`オブションを使えば利用できます。\n\n```js\n/* index.js */\n// An import assertion in a static import\nimport info from `./package.json` assert { type: `json` };\n\n// An import assertion in a dynamic import\nconst { default: info } = await import(\"./package.json\", {\n  assert: {\n    type: \"json\",\n  },\n});\n```\n`v16`でオプション付きで実行する場合は`$ node --experimental-json-modules index.js`と実行します。\nちなみに`--experimental-wasm-modules`というオプションで`wasm`も読み込めます。\n\n### 対象のバージョン以外でやる方法\n1. JSONを読み込み自力でパースする\n```js\nimport { readFile } from 'fs/promises';\nconst json = JSON.parse(\n  await readFile(\n    new URL('./some-file.json', import.meta.url)\n  )\n);\n```\n2. [createRequire](https://nodejs.org/api/module.html#module_module_createrequire_filename)を使う\n```js\nimport { createRequire } from \"module\";\nconst require = createRequire(import.meta.url);\nconst data = require(\"./data.json\");\n```\n\n\n### 参考\n本記事のソースコードおよび内容は以下のリンク先から引用しています。\n- [How to import JSON files in ES modules (Node.js)](https://www.stefanjudis.com/snippets/how-to-import-json-files-in-es-modules-node-js/)\n"},{"slug":"nuxt-auth","frontmatter":{"title":"Nuxt.jsのAuthモジュール(@nuxtjs/auth-next)をわからないなりにざっくり解説する","description":"SPA・SSRの認証ライブラリらしい動きに焦点を当てて説明をする","date":"2023-05-21","tag":["Nuxt.js","JavaScript","Vue"]},"content":"\n### TL;DR\n- CookieとBrowser Storage(Local Storage)を使ってる\n- Cookieが消失することを踏まえ、expires/max-ageは本来的な意味で使っていない\n\n### 時勢の愚痴\nNuxt3.5のリリースが発表された最近ですが、nuxt-communityで開発されているAuthモジュールがいまだに3系に対応できておらず、よくわからん会社がNextAuth(Authentication for Next.js)をラップして作ってるものがNuxt3系をサポートしているよ！なんてことをREADMEに書く始末。  \nそんなNuxtのAuthモジュールの、2系で動いてるものを見た時に理解した一部を説明します。\n\n### 本解説の前提\nローカルスキーマを拡張した[リフレッシュスキーマ](https://auth.nuxtjs.org/schemes/refresh)をもとに解説しています。  \n設定値の例としては以下です。\n```js\nauth: {\n    cookie: {\n      options: {\n        secure: true,\n        sameSite: 'lax',\n        maxAge: 60 * 60 * 24 * 90\n      }\n    },\n    strategies: {\n      local: {\n        scheme: 'refresh',\n        token: {\n          property: 'access_token',\n          maxAge: 60 * 60 * 24\n        },\n        refreshToken: {\n          property: 'refresh_token',\n          data: 'refresh_token',\n          maxAge: 60 * 60 * 24 * 30\n        },\n      }\n    }\n}\n```\n\n\n### @nuxtjs/auth-nextの仕組み\n認証に関わる情報が置かれる場所は主に以下の4つです。\n- Local State(ライブラリ定義)\n- Universal Storage(ライブラリ定義)\n- Cookie(Web標準)\n- Browser Storage(Local Storage)(Web標準)\n\nLocal Stateはローカルな変数やrefオブジェクトだと理解してもらうとして、CookieもBrowser Storageも情報の保存場所としては馴染み深いと思います。  \n残るUniversal Storageは、gitでいうところのstagingエリアで、Local Stateに値を入れることをgit commitだと考えると良いかもです。\n\n\u003cimg alt=\"手書き概要\" src=\"https://i.gyazo.com/6f4ce193bc7158ddbc396e3743ebe384.png\" height=\"250\"\u003e\n\nUniversal Storageの必要性がないかと思われるかもしれませんが、次のような用途があります。  \n\nWebサイトに初回のGETリクエストしたユーザーのブラウザに保存されてる認証情報から取り出せるのは基本的にCookieからのみです。  \nそのため、期限が切れておらず正しい認証情報であれば、SSRをするのに必要な認証情報をLocal Stateに保存すればSSRした結果をユーザーが受け取れてハッピーですが、認証情報が切れている場合は最後までSSRさせてあげることができません。そんな時に役立つのがUniversal StateとBrowser Storageです。  \n\n一般的にCookieよりもBrowser Storageに保存したデータの方が長くユーザーのブラウザ内で生き残ります。  \nそのため、`@nuxtjs/auth-next`では、Cookieに保存する項目(key)が以下のようになっています。\n- アクセストークン\n- リフレッシュトークン\n- アクセストークンの有効期限\n- リフレッシュトークンの有効期限\n\nCookieには`expires/Max-Age`という項目がありますが、`@nuxtjs/auth-next`においてはデフォルトで2週間となっており、ドキュメント内で説明される有効期限とは`別物`となっています。そのため、\n\u003e アクセストークンの有効期限のvalue \u003e `expires/Max-Age`\n\u003e\nといった状況が生まれます。こうなった場合に`@nuxtjs/auth-next`では特に設定をしなくても使用することになっているBrowser Storageに保存していたアクセストークンやリフレッシュトークンの値を取り出し、認証チャレンジに使用することになっています。\n\n\u003cimg alt=\"手書き概要2\" src=\"https://i.gyazo.com/5ab80a9ae3b8ce6e8375aff6015ef72f.jpg\" height=\"300\"\u003e\n\nここまで読んでくれた人には申し訳ありませんが、私の理解はここまでです。\n\n### CookieとBrowser Storageに分かれているメリット/デメリット\n- メリット\n  - Cookieのドメイン属性の変更をしてデプロイをしたとき、すでにユーザーが持ってるアクセストークン等が引き続き利用され、期限が切れたタイミングで新規Cookieに切り替わる\n- デメリット\n  - 複雑度が増す\n\n### Nuxt3サポートがされない理由の考察\nSPA/SSR/SSGモード、認証方式、fetchライブラリ、ストアなどの問題が一番絡み合い、当ライブラリとしても色々な認証方法をサポートしてきた歴史からも互換が切り切れず身動きが取れてない状態だと推測してます。  \n\n超雑にようやくすると、「自分でやってくれ」というコメントが好意的なリアクションが多く、受け入れられているようです。\n\u003e It would be best if you had released this with at least some basic necessity modules (like auth). There are lots of people using Nuxt. Not all will get understand this thing they will have to do it on their own. It's good that you released it but its also affects people with extra burdens. Keep this in mind.\n\u003e \n\u003e I am seeing many peoples not shifting to Nuxt 3 because of these basic things.\n\u003e\n\u003ePeople are just stuck in between because now you can't even install Nuxt 2 freshly. It throughs a Fatal error while running.\n\u003e\n\u003eAnyways, it's great to see you guys work so hard on so many things! I really appreciate your contributions to the world. No hard feelings! :)\n\u003e \u003ccite\u003e[Compatibility with Nuxt 3?\n#1805](https://github.com/nuxt-community/auth-module/issues/1805#issuecomment-1328877117)\u003c/cite\u003e\n\n### 参考文献\n- [GitHub - nuxt-community/auth-module: Zero-boilerplate authentication support for Nuxt.js!](https://github.com/nuxt-community/auth-module)\n"},{"slug":"prsim-codeblock-support","frontmatter":{"title":"忘れがちなPrismJSがサポートしている言語","description":"PrismJSでサポートされている","date":"2022-07-24","tag":["Prism","JavaScript","マークダウン"]},"content":"\n### PrismJSでサポートされている言語を抜粋\n`language-xxxx`の`xxxx`部分に当てはめればいいのがformatに書いてるやつ。\n\n使う機会がありそうで忘れがちなやつをまとめた。jsstacktraceなんてよく使う機会あるはずなのに存在を知らなかった.\n基本的には拡張子を指定すればいける。\n\n\n| lang | format |\n|:-----------|:------------|\n| CSV| csv|\n| Docker| docker|\n| JSON5| json5|\n| JSONP| jsonp|\n| JS stack trace| jsstacktrace|\n| JS Templates| js-templates|\n| JS Extras| js-extras|\n| Markdown| md|\n| React TSX| tsx|\n| React JSX| jsx|\n| JSDoc| jsdoc|\n| GraphQl| graphql|\n| Go module| go-mod|\n| Git| git|\n| ignore| ignore, gitignore, hgignore, npmignore|\n| Log file| log|\n| SQL| sql|\n\n### その他感想\nnginxやapplescriptなどもサポートされてるみたいで懐が深い。\n\n### 参考文献\n- [prism - Supported Laungages](https://prismjs.com/#supported-languages)"},{"slug":"ts-jest-fail-because-import-global-jset","frontmatter":{"title":"Jest(ts-jest)で作ったはずのmockがundefinedになるエラー","description":"Jestで遭遇したエラー","date":"2022-09-19","tag":["Jest","TypeScript","JavaScript"]},"content":"### 結論\nts-jest?esmで書いてるから？とりあえずでimportするのやめよう。\n\n### 状況\nJestの右も左もわからないがfetcをmockしてゴニョゴニョしていた。  \n[公式の例](https://jestjs.io/docs/mock-function-api/#jestmockedsource)にもnode-fetchを使った例が載ってるぐらいなので、コピペして動かそうとしていたら問題発生。\n\n\n以下のエラーが発生した。\n```jsstacktrace\nTypeError: mockGetImageFromWeb.mockClear is not a function\n  23 |\n  24 |   afterEach(() =\u003e {\n\u003e 25 |     mockGetImageFromWeb.mockClear()\n     |                         ^\n  26 |   })\n  27 |   test('should be defined', () =\u003e {\n  28 |     expect(getImageFromWeb).toBeDefined()\n```\n\nコピペしたコードはこれ\n```js\nimport {expect, jest, test} from '@jest/globals';\nimport type {fetch} from 'node-fetch';\n\njest.mock('node-fetch');\n\nlet mockedFetch: jest.Mocked\u003ctypeof fetch\u003e;\n\nafterEach(() =\u003e {\n  mockedFetch.mockClear();\n});\n\ntest('makes correct call', () =\u003e {\n  mockedFetch = getMockedFetch();\n  // ...\n});\n\ntest('returns correct data', () =\u003e {\n  mockedFetch = getMockedFetch();\n  // ...\n});\n```\n\n\n### 対応\nコピペしてきたtestファイルで以下のインポート文を削除したら動いた。\n```js\nimport { expect, jest, test } from '@jest/globals'\n```\n\n### 参考文献\n- [Mock Functions · Jest](https://jestjs.io/docs/mock-function-api/#jestmockedsource)\n- [How To Mock Fetch in Jest | Leigh Halliday](https://www.leighhalliday.com/mock-fetch-jest)\n\n\n"},{"slug":"typeorm-to-me","frontmatter":{"title":"私が知ってるTypeORMについて、またはPrismaとの比較","description":"TypeORMに対して私が思ったこと","date":"2024-11-19","tag":["JavaScript","TypeScript"]},"content":"\n## はじめに\n私はTypeORMについてかなりネガティブ寄り\nな意見を持っています。  \nこれはTypeScript環境でのORMは[Prisma](https://www.prisma.io/)が1強とされる2023年、そんな時期に”Tier2以下”とされるORMを使うことを強いられたからにほかならないと思いますが、その”Tier2以下”から見える景色というのは貴重だという思いで、自分から見えた景色を書いていきます。  \nORMの厳密な定義はわかりませんが、ORMかそうじゃないかという論争をたまに見かけます。自分には判断がつかないのでTypeORMやPrismaによき期待される層のことを総称してORMとこの記事の中では呼びます。  \n\n## ここがだめだよTypeORM\n### 型が取り出しづらい\nまずTypeORMのテーブル定義はClassとデコレータで行われます。\n```ts\nimport { Entity, PrimaryGeneratedColumn, Column } from \"typeorm\"\n\n@Entity({ database: \"secondDB\" })\nexport class User {\n    @PrimaryGeneratedColumn()\n    id: number\n\n    @Column()\n    firstName: string\n\n    @Column()\n    lastName: string\n}\n```\n\nリレーションの記述もこれに従います。  \n\n```ts\n@Entity({ database: \"secondDB\" })\nexport class User {\n    @PrimaryGeneratedColumn()\n    id: number\n\n    @Column()\n    firstName: string\n\n    @Column()\n    lastName: string\n\n    @OneToMany(() =\u003e Photo, (photo) =\u003e photo.user)\n    photos: Photo[]\n}\n```\n\n次にUserテーブルから条件に一致するデータを取り出すときはこう書きます。\n```ts\nuserRepository.find({\n      where: {\n        firstName: \"Timber\",\n        lastName: \"Saw\",\n    },\n})\n```\nここにもうTypeORMの嫌なところが顔を出します。  \n上のコードの返り値からPromiseを解決させると`Userインスタンス`が現れます。  \nつまり、この型には`{ photos: Photo[] }`が含まれています。もちろん実行結果にはphotosは含まれず、relation先も含めて取得する場合はそれ用のオプションがあります。  \n最悪ですね。  \n  \n対応作はもちろんあって、元のUserからOmitしたものをベースに使用し、オプション次第で自分たちで型を組み立てるということもできるわけですが、二度手間です。Prismaならここらもうまくやってくれます。  \n\nちなみに[クエリビルダ](https://typeorm.io/update-query-builder)として使っても一緒です。（Prismaは最近クエリビルダでSQLを書いたらそのSQLに応じた型を提供してくれるようになったというニュースを最近みました。実際にまだ使ってないのでどの程度のものなにかは知りません。）  \n\n### いまだにメジャーバージョンがリリースされてない\n\nTypeORMの名前はよく聞くかと思いますが、実はまだv0.3あたりで、数年前にでました。それまでv0.1やv0.2です。  \n0.2から0.3で破壊的な変更も入っています。  \n\n## 個人的な所感\nTypeORMはTypeScriptバックエンドの初期を担ったツールという印象で、今ではもう時代遅れだと感じます。  \nその理由は自分の中で明確で、テーブル定義もTypeScriptで行おうとした点にあると思っています。  \nリレーショナルデータベースでよく使う機能に限って言っても、デコレータは使わないシンプルなTypeScriptの表現力でカバーしきれていません。そこを近道的にクラスとデコレータで表現をしたため行き詰まり、Prismaにその座を奪われたという印象です。PrismaはDSLですしね。  \nソフトウェアの栄枯盛衰のサイクルについて学びがあったような、なかったような気がします。  \n素直に時代にあった選択肢を選択しよう。  \n\n\n### 参考文献\n- [Prisma | Simplify working and interacting with databases ](https://www.prisma.io/)\n- [Update using Query Builder | TypeORM](https://typeorm.io/update-query-builder)\n"},{"slug":"v8engine-asm-show","frontmatter":{"title":"V8エンジン（JavaScript）が吐くアセンブリを見たい！","date":"2022-01-09","tag":["JavaScript","Node.js"]},"content":"\nアセンブリを読みたい願望がある。\nnodeでもV8エンジンの`--print-code`オプションが使える。\n```bash\n$ node --print-code sample.js\n$ d8 --print-code sample.js\n```\n\n実際に出力してみたけど、自分で書いたコード部分すら見つからず、わけわからんかった。\n（Raw Codeとして出力されると紹介されていたが、見当たらなかった。）\n\n\n### 参考\n- [v8でjsとwasmのアセンブリを取る方法](https://zenn.dev/umashiba/articles/d64fb62a09fb4f)\n- [GitHubの公式ミラーリポジトリ](https://github.com/v8/v8)\n- [公式Gitリポジトリ](https://chromium.googlesource.com/v8/v8.git)\n- [https://v8.dev/docs](https://v8.dev/docs)\n"}]},"__N_SSG":true},"page":"/tag/[tag]","query":{"tag":"JavaScript"},"buildId":"VqcCu3B2NG7b3qjj5q9Nd","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>