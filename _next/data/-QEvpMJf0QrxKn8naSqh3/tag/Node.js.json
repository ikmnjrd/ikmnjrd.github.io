{"pageProps":{"tag":"Node.js","posts":[{"slug":"next-sitemap-sample","frontmatter":{"title":"Next.jsのサンプル集を参考にサイトマップを作成しようとしたらエラー","date":"2022-02-08","tag":["Node.js","Next.js","JavaScript"]},"content":"エラーに遭遇しました。\n\n### 環境\n- Node: v16.13.2\n- Next.js: 12.0.10\n- globby: 13.1.1\n\n[公式のサンプル集の「with-sitemap」](https://github.com/vercel/next.js/tree/canary/examples/with-sitemap)では以下のようなスクリプトをサーバー実行時に（`next.config.js`のisServerオブションをフラグにして）実行している。\n\n\n./scripts/generate-sitemap.js\n```javascript\nconst fs = require('fs')\nconst globby = require('globby')\n\nfunction addPage(page) {\n  const path = page.replace('pages', '').replace('.js', '').replace('.mdx', '')\n  const route = path === '/index' ? '' : path\n\n  return `  <url>\n    <loc>${`${process.env.WEBSITE_URL}${route}`}</loc>\n    <changefreq>hourly</changefreq>\n  </url>`\n}\n\nasync function generateSitemap() {\n  // Ignore Next.js specific files (e.g., _app.js) and API routes.\n  const pages = await globby([\n    'pages/**/*{.js,.mdx}',\n    '!pages/_*.js',\n    '!pages/api',\n  ])\n  const sitemap = `<urlset xmlns=\"http://www.sitemaps.org/schemas/sitemap/0.9\">\n${pages.map(addPage).join('\\n')}\n</urlset>`\n\n  fs.writeFileSync('public/sitemap.xml', sitemap)\n}\n\ngenerateSitemap()\n\n```\n\n\n遭遇したエラーは以下\n\n```bash\nError [ERR_REQUIRE_ESM]: require() of ES Module ./node_modules/globby/index.js from ./scripts/generate-sitemap.js not supported.\nInstead change the require of index.js in ./scripts/generate-sitemap.js to a dynamic import() which is available in all CommonJS modules.\n```\n\n最新のglobbyからはCommonJSが省かれたらしい。\n\n\n### 解決策\npackage.jsonを以下のように書き換え、`$npm i`を実行\n```json\n\"globby\": \"^13.1.1\",\n```\n↓\n```json\n\"globby\": \"^11.0.1\",\n```\n\nインストール後、ビルド時に`./public/sitemap.xml`が無事出力された。\n\n\n### 周辺用語\n- commonJS\n- ESModules\n\n\n### 参考文献\n- [Build a sitemap generator in Next.js - LogRocket Blog](https://blog.logrocket.com/build-sitemap-generator-nextjs/)"}]},"__N_SSG":true}