{"pageProps":{"frontmatter":{"title":"Next.jsのサンプル集を参考にサイトマップを作成しようとしたらエラー","date":"2022-02-08","tag":["Node.js","Next.js","JavaScript"]},"slug":"next-sitemap-sample","innerHtml":"<p>エラーに遭遇しました。</p>\n<h3 id=\"%E7%92%B0%E5%A2%83\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#%E7%92%B0%E5%A2%83\" aria-hidden=\"true\">#</a> 環境</h3>\n<ul>\n<li>Node: v16.13.2</li>\n<li>Next.js: 12.0.10</li>\n<li>globby: 13.1.1</li>\n</ul>\n<p><a href=\"https://github.com/vercel/next.js/tree/canary/examples/with-sitemap\">公式のサンプル集の「with-sitemap」</a>では以下のようなスクリプトをサーバー実行時に（<code>next.config.js</code>のisServerオブションをフラグにして）実行している。</p>\n<p>./scripts/generate-sitemap.js</p>\n<pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> fs <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'fs'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> globby <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'globby'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">addPage</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">page</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> path <span class=\"token operator\">=</span> page<span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><span class=\"token string\">'pages'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">''</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><span class=\"token string\">'.js'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">''</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><span class=\"token string\">'.mdx'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">''</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">const</span> route <span class=\"token operator\">=</span> path <span class=\"token operator\">===</span> <span class=\"token string\">'/index'</span> <span class=\"token operator\">?</span> <span class=\"token string\">''</span> <span class=\"token operator\">:</span> path\n\n  <span class=\"token keyword\">return</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">  &lt;url>\n    &lt;loc></span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">WEBSITE_URL</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>route<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">&lt;/loc>\n    &lt;changefreq>hourly&lt;/changefreq>\n  &lt;/url></span><span class=\"token template-punctuation string\">`</span></span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">generateSitemap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// Ignore Next.js specific files (e.g., _app.js) and API routes.</span>\n  <span class=\"token keyword\">const</span> pages <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">globby</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\n    <span class=\"token string\">'pages/**/*{.js,.mdx}'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'!pages/_*.js'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'!pages/api'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">const</span> sitemap <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">&lt;urlset xmlns=\"http://www.sitemaps.org/schemas/sitemap/0.9\">\n</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>pages<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>addPage<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token string\">'\\n'</span><span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">\n&lt;/urlset></span><span class=\"token template-punctuation string\">`</span></span>\n\n  fs<span class=\"token punctuation\">.</span><span class=\"token function\">writeFileSync</span><span class=\"token punctuation\">(</span><span class=\"token string\">'public/sitemap.xml'</span><span class=\"token punctuation\">,</span> sitemap<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token function\">generateSitemap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n</code></pre>\n<p>遭遇したエラーは以下</p>\n<pre class=\"language-bash\"><code class=\"language-bash\">Error <span class=\"token punctuation\">[</span>ERR_REQUIRE_ESM<span class=\"token punctuation\">]</span>: require<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> of ES Module ./node_modules/globby/index.js from ./scripts/generate-sitemap.js not supported.\nInstead change the require of index.js <span class=\"token keyword\">in</span> ./scripts/generate-sitemap.js to a dynamic import<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token function\">which</span> is available <span class=\"token keyword\">in</span> all CommonJS modules.\n</code></pre>\n<p>最新のglobbyからはCommonJSが省かれたらしい。</p>\n<h3 id=\"%E8%A7%A3%E6%B1%BA%E7%AD%96\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#%E8%A7%A3%E6%B1%BA%E7%AD%96\" aria-hidden=\"true\">#</a> 解決策</h3>\n<p>package.jsonを以下のように書き換え、<code>$npm i</code>を実行</p>\n<pre class=\"language-json\"><code class=\"language-json\"><span class=\"token property\">\"globby\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"^13.1.1\"</span><span class=\"token punctuation\">,</span>\n</code></pre>\n<p>↓</p>\n<pre class=\"language-json\"><code class=\"language-json\"><span class=\"token property\">\"globby\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"^11.0.1\"</span><span class=\"token punctuation\">,</span>\n</code></pre>\n<p>インストール後、ビルド時に<code>./public/sitemap.xml</code>が無事出力された。</p>\n<h3 id=\"%E5%91%A8%E8%BE%BA%E7%94%A8%E8%AA%9E\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#%E5%91%A8%E8%BE%BA%E7%94%A8%E8%AA%9E\" aria-hidden=\"true\">#</a> 周辺用語</h3>\n<ul>\n<li>commonJS</li>\n<li>ESModules</li>\n</ul>\n<h3 id=\"%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE\" aria-hidden=\"true\">#</a> 参考文献</h3>\n<ul>\n<li><a href=\"https://blog.logrocket.com/build-sitemap-generator-nextjs/\">Build a sitemap generator in Next.js - LogRocket Blog</a></li>\n</ul>\n","anchors":[{"text":"環境","link":"%E7%92%B0%E5%A2%83"},{"text":"解決策","link":"%E8%A7%A3%E6%B1%BA%E7%AD%96"},{"text":"周辺用語","link":"%E5%91%A8%E8%BE%BA%E7%94%A8%E8%AA%9E"},{"text":"参考文献","link":"%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE"}]},"__N_SSG":true}