{"pageProps":{"frontmatter":{"title":"Nuxt.jsのAuthモジュール(@nuxtjs/auth-next)をわからないなりにざっくり解説する","description":"SPA・SSRの認証ライブラリらしい動きに焦点を当てて説明をする","date":"2023-05-21","tag":["Nuxt.js","JavaScript","Vue"]},"slug":"nuxt-auth","innerHtml":"<h3 id=\"tl%3Bdr\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#tl%3Bdr\" aria-hidden=\"true\">#</a> TL;DR</h3>\n<ul>\n<li>CookieとBrowser Storage(Local Storage)を使ってる</li>\n<li>Cookieが消失することを踏まえ、expires/max-ageは本来的な意味で使っていない</li>\n</ul>\n<h3 id=\"%E6%99%82%E5%8B%A2%E3%81%AE%E6%84%9A%E7%97%B4\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#%E6%99%82%E5%8B%A2%E3%81%AE%E6%84%9A%E7%97%B4\" aria-hidden=\"true\">#</a> 時勢の愚痴</h3>\n<p>Nuxt3.5のリリースが発表された最近ですが、nuxt-communityで開発されているAuthモジュールがいまだに3系に対応できておらず、よくわからん会社がNextAuth(Authentication for Next.js)をラップして作ってるものがNuxt3系をサポートしているよ！なんてことをREADMEに書く始末。<br>\nそんなNuxtのAuthモジュールの、2系で動いてるものを見た時に理解した一部を説明します。</p>\n<h3 id=\"%E6%9C%AC%E8%A7%A3%E8%AA%AC%E3%81%AE%E5%89%8D%E6%8F%90\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#%E6%9C%AC%E8%A7%A3%E8%AA%AC%E3%81%AE%E5%89%8D%E6%8F%90\" aria-hidden=\"true\">#</a> 本解説の前提</h3>\n<p>ローカルスキーマを拡張した<a href=\"https://auth.nuxtjs.org/schemes/refresh\">リフレッシュスキーマ</a>をもとに解説しています。<br>\n設定値の例としては以下です。</p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token literal-property property\">auth</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">cookie</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token literal-property property\">options</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token literal-property property\">secure</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n        <span class=\"token literal-property property\">sameSite</span><span class=\"token operator\">:</span> <span class=\"token string\">'lax'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token literal-property property\">maxAge</span><span class=\"token operator\">:</span> <span class=\"token number\">60</span> <span class=\"token operator\">*</span> <span class=\"token number\">60</span> <span class=\"token operator\">*</span> <span class=\"token number\">24</span> <span class=\"token operator\">*</span> <span class=\"token number\">90</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">strategies</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token literal-property property\">local</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token literal-property property\">scheme</span><span class=\"token operator\">:</span> <span class=\"token string\">'refresh'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token literal-property property\">token</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token literal-property property\">property</span><span class=\"token operator\">:</span> <span class=\"token string\">'access_token'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token literal-property property\">maxAge</span><span class=\"token operator\">:</span> <span class=\"token number\">60</span> <span class=\"token operator\">*</span> <span class=\"token number\">60</span> <span class=\"token operator\">*</span> <span class=\"token number\">24</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token literal-property property\">refreshToken</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token literal-property property\">property</span><span class=\"token operator\">:</span> <span class=\"token string\">'refresh_token'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token literal-property property\">data</span><span class=\"token operator\">:</span> <span class=\"token string\">'refresh_token'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token literal-property property\">maxAge</span><span class=\"token operator\">:</span> <span class=\"token number\">60</span> <span class=\"token operator\">*</span> <span class=\"token number\">60</span> <span class=\"token operator\">*</span> <span class=\"token number\">24</span> <span class=\"token operator\">*</span> <span class=\"token number\">30</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<h3 id=\"%40nuxtjs%2Fauth-next%E3%81%AE%E4%BB%95%E7%B5%84%E3%81%BF\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#%40nuxtjs%2Fauth-next%E3%81%AE%E4%BB%95%E7%B5%84%E3%81%BF\" aria-hidden=\"true\">#</a> @nuxtjs/auth-nextの仕組み</h3>\n<p>認証に関わる情報が置かれる場所は主に以下の4つです。</p>\n<ul>\n<li>Local State(ライブラリ定義)</li>\n<li>Universal Storage(ライブラリ定義)</li>\n<li>Cookie(Web標準)</li>\n<li>Browser Storage(Local Storage)(Web標準)</li>\n</ul>\n<p>Local Stateはローカルな変数やrefオブジェクトだと理解してもらうとして、CookieもBrowser Storageも情報の保存場所としては馴染み深いと思います。<br>\n残るUniversal Storageは、gitでいうところのstagingエリアで、Local Stateに値を入れることをgit commitだと考えると良いかもです。</p>\n<img alt=\"手書き概要\" src=\"/images/posts/nuxt-auth-0.avif\" height=\"250\">\n<p>Universal Storageの必要性がないかと思われるかもしれませんが、次のような用途があります。</p>\n<p>Webサイトに初回のGETリクエストしたユーザーのブラウザに保存されてる認証情報から取り出せるのは基本的にCookieからのみです。<br>\nそのため、期限が切れておらず正しい認証情報であれば、SSRをするのに必要な認証情報をLocal Stateに保存すればSSRした結果をユーザーが受け取れてハッピーですが、認証情報が切れている場合は最後までSSRさせてあげることができません。そんな時に役立つのがUniversal StateとBrowser Storageです。</p>\n<p>一般的にCookieよりもBrowser Storageに保存したデータの方が長くユーザーのブラウザ内で生き残ります。<br>\nそのため、<code>@nuxtjs/auth-next</code>では、Cookieに保存する項目(key)が以下のようになっています。</p>\n<ul>\n<li>アクセストークン</li>\n<li>リフレッシュトークン</li>\n<li>アクセストークンの有効期限</li>\n<li>リフレッシュトークンの有効期限</li>\n</ul>\n<p>Cookieには<code>expires/Max-Age</code>という項目がありますが、<code>@nuxtjs/auth-next</code>においてはデフォルトで2週間となっており、ドキュメント内で説明される有効期限とは<code>別物</code>となっています。そのため、</p>\n<blockquote>\n<p>アクセストークンの有効期限のvalue &gt; <code>expires/Max-Age</code></p>\n</blockquote>\n<p>といった状況が生まれます。こうなった場合に<code>@nuxtjs/auth-next</code>では特に設定をしなくても使用することになっているBrowser Storageに保存していたアクセストークンやリフレッシュトークンの値を取り出し、認証チャレンジに使用することになっています。</p>\n<img alt=\"手書き概要2\" src=\"/images/posts/nuxt-auth-1.avif\" height=\"300\">\n<p>ここまで読んでくれた人には申し訳ありませんが、私の理解はここまでです。</p>\n<h3 id=\"cookie%E3%81%A8browser-storage%E3%81%AB%E5%88%86%E3%81%8B%E3%82%8C%E3%81%A6%E3%81%84%E3%82%8B%E3%83%A1%E3%83%AA%E3%83%83%E3%83%88%2F%E3%83%87%E3%83%A1%E3%83%AA%E3%83%83%E3%83%88\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#cookie%E3%81%A8browser-storage%E3%81%AB%E5%88%86%E3%81%8B%E3%82%8C%E3%81%A6%E3%81%84%E3%82%8B%E3%83%A1%E3%83%AA%E3%83%83%E3%83%88%2F%E3%83%87%E3%83%A1%E3%83%AA%E3%83%83%E3%83%88\" aria-hidden=\"true\">#</a> CookieとBrowser Storageに分かれているメリット/デメリット</h3>\n<ul>\n<li>メリット\n<ul>\n<li>Cookieのドメイン属性の変更をしてデプロイをしたとき、すでにユーザーが持ってるアクセストークン等が引き続き利用され、期限が切れたタイミングで新規Cookieに切り替わる</li>\n</ul>\n</li>\n<li>デメリット\n<ul>\n<li>複雑度が増す</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"nuxt3%E3%82%B5%E3%83%9D%E3%83%BC%E3%83%88%E3%81%8C%E3%81%95%E3%82%8C%E3%81%AA%E3%81%84%E7%90%86%E7%94%B1%E3%81%AE%E8%80%83%E5%AF%9F\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#nuxt3%E3%82%B5%E3%83%9D%E3%83%BC%E3%83%88%E3%81%8C%E3%81%95%E3%82%8C%E3%81%AA%E3%81%84%E7%90%86%E7%94%B1%E3%81%AE%E8%80%83%E5%AF%9F\" aria-hidden=\"true\">#</a> Nuxt3サポートがされない理由の考察</h3>\n<p>SPA/SSR/SSGモード、認証方式、fetchライブラリ、ストアなどの問題が一番絡み合い、当ライブラリとしても色々な認証方法をサポートしてきた歴史からも互換が切り切れず身動きが取れてない状態だと推測してます。</p>\n<p>超雑にようやくすると、「自分でやってくれ」というコメントが好意的なリアクションが多く、受け入れられているようです。</p>\n<blockquote>\n<p>It would be best if you had released this with at least some basic necessity modules (like auth). There are lots of people using Nuxt. Not all will get understand this thing they will have to do it on their own. It's good that you released it but its also affects people with extra burdens. Keep this in mind.</p>\n<p>I am seeing many peoples not shifting to Nuxt 3 because of these basic things.</p>\n<p>People are just stuck in between because now you can't even install Nuxt 2 freshly. It throughs a Fatal error while running.</p>\n<p>Anyways, it's great to see you guys work so hard on so many things! I really appreciate your contributions to the world. No hard feelings! :)\n<cite><a href=\"https://github.com/nuxt-community/auth-module/issues/1805#issuecomment-1328877117\">Compatibility with Nuxt 3?\n#1805</a></cite></p>\n</blockquote>\n<h3 id=\"%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE\" aria-hidden=\"true\">#</a> 参考文献</h3>\n<ul>\n<li><a href=\"https://github.com/nuxt-community/auth-module\">GitHub - nuxt-community/auth-module: Zero-boilerplate authentication support for Nuxt.js!</a></li>\n</ul>\n"},"__N_SSG":true}