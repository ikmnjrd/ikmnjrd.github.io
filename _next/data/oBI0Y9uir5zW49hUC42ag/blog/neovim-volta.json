{"pageProps":{"frontmatter":{"title":"NeoVimとvoltaを併用するとNodeを見つけてくれない問題","description":"NeoVimとvoltaを使うと必ずこの問題にぶち当たるのでは？","date":"2022-10-13","tag":["Node.js","NeoVim","JavaScript","volta"]},"slug":"neovim-volta","innerHtml":"<h2 id=\"%E7%92%B0%E5%A2%83\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#%E7%92%B0%E5%A2%83\" aria-hidden=\"true\">#</a> 環境</h2>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">関連ソフトウェア</th>\n<th style=\"text-align:left\">バージョン</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">macOS</td>\n<td style=\"text-align:left\">12.6</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">NodeJS</td>\n<td style=\"text-align:left\">16.17.0</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">volta</td>\n<td style=\"text-align:left\">1.0.8</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">NeoVim</td>\n<td style=\"text-align:left\">8.0</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"%E7%B5%90%E8%AB%96\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#%E7%B5%90%E8%AB%96\" aria-hidden=\"true\">#</a> 結論</h2>\n<p>voltaを使うなら<a href=\"https://github.com/volta-cli/volta/issues/866\">voltaのIssue</a>にあるようにinit.vimに以下のような記述をしておく。</p>\n<pre class=\"language-vim\"><code class=\"language-vim\"><span class=\"token keyword\">if</span> <span class=\"token function\">executable</span><span class=\"token punctuation\">(</span><span class=\"token string\">'volta'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">let</span> g<span class=\"token punctuation\">:</span>node_host_prog <span class=\"token operator\">=</span> <span class=\"token function\">trim</span><span class=\"token punctuation\">(</span><span class=\"token function\">system</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"volta which neovim-node-host\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">endif</span>\n</code></pre>\n<h2 id=\"%E7%B5%8C%E7%B7%AF%E3%81%A8%E3%82%B7%E3%83%A5%E3%83%BC%E3%83%86%E3%82%A3%E3%83%B3%E3%82%B0%E3%82%BF%E3%82%A4%E3%83%A0%E3%83%A9%E3%82%A4%E3%83%B3\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#%E7%B5%8C%E7%B7%AF%E3%81%A8%E3%82%B7%E3%83%A5%E3%83%BC%E3%83%86%E3%82%A3%E3%83%B3%E3%82%B0%E3%82%BF%E3%82%A4%E3%83%A0%E3%83%A9%E3%82%A4%E3%83%B3\" aria-hidden=\"true\">#</a> 経緯とシューティングタイムライン</h2>\n<p>仕事でNeoVimは一切使っていないのですが、休日趣味的に開いてみたらなんか様子がおかしい。</p>\n<p>NeoVimを開いて<code>:checkhealth provider</code>を入力すると、以下のようなメッセージ。</p>\n<pre class=\"language-markdown\"><code class=\"language-markdown\"><span class=\"token title important\">provider: health#provider#check\n<span class=\"token punctuation\">========================================================================</span></span>\n\n<span class=\"token title important\"><span class=\"token punctuation\">##</span> Node.js provider (optional)</span>\n  <span class=\"token list punctuation\">-</span> INFO: Node.js: v16.17.0\n  <span class=\"token list punctuation\">-</span> WARNING: Missing \"neovim\" npm (or yarn, pnpm) package.\n    <span class=\"token list punctuation\">-</span> ADVICE:\n      <span class=\"token list punctuation\">-</span> Run in shell: npm install -g neovim\n      <span class=\"token list punctuation\">-</span> Run in shell (if you use yarn): yarn global add neovim\n      <span class=\"token list punctuation\">-</span> Run in shell (if you use pnpm): pnpm install -g neovim\n      <span class=\"token list punctuation\">-</span> You may disable this provider (and warning) by adding <span class=\"token code-snippet code keyword\">`let g:loaded_node_provider = 0`</span> to your init.vim\n\n</code></pre>\n<p><code>npm install -g neovim</code>もしくは<code>volta install neovim</code>をしても変わらない。<br>\nここで<a href=\"https://neovim.io/doc/user/provider.html\">公式のHelp</a>を読むと、</p>\n<blockquote>\n<p>By default, Nvim searches for &quot;neovim-node-host&quot; using &quot;npm root -g&quot;, which can be slow. To avoid this, set g:node_host_prog to the host path: <cite><a href=\"https://neovim.io/doc/user/provider.html\">Provider - Neovim docs</a></cite></p>\n</blockquote>\n<p>自分のvoltaを使ってる環境で<code>npm root -g</code>を実行すると以下のような結果に。</p>\n<pre class=\"language-sh\"><code class=\"language-sh\">/Users/ike/.volta/tools/image/node/16.17.0/lib/node_modules\n</code></pre>\n<p>ということで、<code>g:node_host_prog</code>オプションを設定したいが、うまくいかん。<br>\nそもそもvoltaを使ってグローバルインストールしたパッケージは<code>/Users/ike/.volta/bin/volta-shim</code>にshimとしてインストールされ、シンボリックリンクが貼られる形をとっている。<br>\nこんな感じ</p>\n<pre class=\"language-sh\"><code class=\"language-sh\">% <span class=\"token function\">ls</span> <span class=\"token parameter variable\">-al</span> ~/.volta/bin\ndrwxr-xr-x  <span class=\"token number\">12</span> ike  staff      <span class=\"token number\">384</span> Oct <span class=\"token number\">13</span> <span class=\"token number\">16</span>:45 <span class=\"token builtin class-name\">.</span>\ndrwxr-xr-x   <span class=\"token number\">9</span> ike  staff      <span class=\"token number\">288</span> Sep <span class=\"token number\">10</span> <span class=\"token number\">23</span>:29 <span class=\"token punctuation\">..</span>\nlrwxr-xr-x   <span class=\"token number\">1</span> ike  staff       <span class=\"token number\">32</span> Sep <span class=\"token number\">21</span> <span class=\"token number\">21</span>:34 http-server -<span class=\"token operator\">></span> /Users/ike/.volta/bin/volta-shim\nlrwxr-xr-x   <span class=\"token number\">1</span> ike  staff       <span class=\"token number\">32</span> Sep <span class=\"token number\">15</span> <span class=\"token number\">23</span>:36 memlab -<span class=\"token operator\">></span> /Users/ike/.volta/bin/volta-shim\nlrwxr-xr-x   <span class=\"token number\">1</span> ike  staff       <span class=\"token number\">32</span> Oct <span class=\"token number\">13</span> <span class=\"token number\">16</span>:45 neovim-node-host -<span class=\"token operator\">></span> /Users/ike/.volta/bin/volta-shim\nlrwxr-xr-x   <span class=\"token number\">1</span> ike  staff       <span class=\"token number\">32</span> Sep <span class=\"token number\">10</span> <span class=\"token number\">23</span>:29 <span class=\"token function\">node</span> -<span class=\"token operator\">></span> /Users/ike/.volta/bin/volta-shim\nlrwxr-xr-x   <span class=\"token number\">1</span> ike  staff       <span class=\"token number\">32</span> Sep <span class=\"token number\">10</span> <span class=\"token number\">23</span>:29 <span class=\"token function\">npm</span> -<span class=\"token operator\">></span> /Users/ike/.volta/bin/volta-shim\nlrwxr-xr-x   <span class=\"token number\">1</span> ike  staff       <span class=\"token number\">32</span> Sep <span class=\"token number\">10</span> <span class=\"token number\">23</span>:29 npx -<span class=\"token operator\">></span> /Users/ike/.volta/bin/volta-shim\n-rwxr-xr-x   <span class=\"token number\">1</span> ike  staff  <span class=\"token number\">6522504</span> Jun  <span class=\"token number\">2</span> 09:14 volta\n-rwxr-xr-x   <span class=\"token number\">1</span> ike  staff  <span class=\"token number\">4771376</span> Jun  <span class=\"token number\">2</span> 09:14 volta-migrate\n-rwxr-xr-x   <span class=\"token number\">1</span> ike  staff  <span class=\"token number\">5522480</span> Jun  <span class=\"token number\">2</span> 09:14 volta-shim\nlrwxr-xr-x   <span class=\"token number\">1</span> ike  staff       <span class=\"token number\">32</span> Sep <span class=\"token number\">10</span> <span class=\"token number\">23</span>:29 <span class=\"token function\">yarn</span> -<span class=\"token operator\">></span> /Users/ike/.volta/bin/volta-shim\n</code></pre>\n<p>わからん状態だったため、GitHubを探し、<a href=\"#%E7%B5%90%E8%AB%96\">結論</a>部分でも貼ったコードをコピペして終了。<br>\nVim(NeoVim)わからん。</p>\n<h3 id=\"%E5%91%A8%E8%BE%BA%E7%94%A8%E8%AA%9E\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#%E5%91%A8%E8%BE%BA%E7%94%A8%E8%AA%9E\" aria-hidden=\"true\">#</a> 周辺用語</h3>\n<ul>\n<li>Shim</li>\n</ul>\n<h3 id=\"%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE\" aria-hidden=\"true\">#</a> 参考文献</h3>\n<ul>\n<li><a href=\"https://github.com/volta-cli/volta/issues/866\">volta + neovim compatibility issues · Issue #866 · volta-cli/volta</a></li>\n<li><a href=\"https://docs.volta.sh/guide/understanding#managing-your-toolchain\">Understanding Volta | Volta</a></li>\n<li><a href=\"https://neovim.io/doc/user/provider.html\">Provider - Neovim docs</a></li>\n<li><a href=\"https://qiita.com/ybiquitous/items/3104beb84b78ca15f407\">Shim と Polyfill</a></li>\n</ul>\n","createdAt":"2022-10-18","updatedAt":"2022-10-18"},"__N_SSG":true}