{"pageProps":{"frontmatter":{"title":"GitHubにpushした時に特定コマンドの実行結果でマージ可否の設定","description":"GitHubでpushした時にマージ可否を設定する","date":"2022-09-11","tag":["GitHub","CI/CD"]},"slug":"push-and-test-with-github-actions","innerHtml":"<h2 id=\"%E6%89%8B%E9%A0%86\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#%E6%89%8B%E9%A0%86\" aria-hidden=\"true\">#</a> 手順</h2>\n<p>ワークフローの設定（コード管理できるもの）とGitHubのUI上から設定するものに分けて考える</p>\n<h3 id=\"%E3%83%AF%E3%83%BC%E3%82%AF%E3%83%95%E3%83%AD%E3%83%BC%E3%81%AE%E8%A8%AD%E5%AE%9A\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#%E3%83%AF%E3%83%BC%E3%82%AF%E3%83%95%E3%83%AD%E3%83%BC%E3%81%AE%E8%A8%AD%E5%AE%9A\" aria-hidden=\"true\">#</a> ワークフローの設定</h3>\n<p>例として貼り付けますが、<a href=\"https://docs.github.com/ja/actions/examples/using-scripts-to-test-your-code-on-a-runner\">ここ</a>を参考にするなど自分の環境に合わせカスタマイズしてください。</p>\n<pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> exec<span class=\"token punctuation\">-</span>tests\n<span class=\"token key atrule\">on</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">push</span><span class=\"token punctuation\">:</span>\n\n<span class=\"token key atrule\">jobs</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">status-check</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">runs-on</span><span class=\"token punctuation\">:</span> ubuntu<span class=\"token punctuation\">-</span>latest\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Checkout\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/checkout@v3\n\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Use Node.js $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> inputs.node<span class=\"token punctuation\">-</span>version <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/setup<span class=\"token punctuation\">-</span>node@v3\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">node-version</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'16.x'</span>\n\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Get Cache Dependencies\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/cache@v3\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> ~/.npm\n          <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> runner.os <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">-</span>node<span class=\"token punctuation\">-</span>$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> hashFiles('<span class=\"token important\">**/package-lock.json')</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n          <span class=\"token key atrule\">restore-keys</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n            ${{ runner.os }}-node-</span>\n\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Install Dependencies\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> npm ci\n\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Create avif images dir\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> mkdir tmp\n\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Build\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> npm run build\n        <span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">NODE_OPTIONS</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'--max_old_space_size=4096'</span>\n\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Check by linter\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> npm run lint\n\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Check by TypeScript Compiler\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> npm run typecheck\n\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Run Tests\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> npm run test\n\n</code></pre>\n<h3 id=\"%E3%83%AA%E3%83%9D%E3%82%B8%E3%83%88%E3%83%AA(web%E4%B8%8A%E3%81%8B%E3%82%89)%E3%81%AE%E8%A8%AD%E5%AE%9A\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#%E3%83%AA%E3%83%9D%E3%82%B8%E3%83%88%E3%83%AA(web%E4%B8%8A%E3%81%8B%E3%82%89)%E3%81%AE%E8%A8%AD%E5%AE%9A\" aria-hidden=\"true\">#</a> リポジトリ(Web上から)の設定</h3>\n<p>以下の画面から編集\n<img src=\"/images/posts/push-and-test-with-github-actions-0.avif\" alt=\"create-protection\">\nmainブランチの保護をするため、「main」と入力。<br>\n「Require status checks to pass before merging」にチェックを入れ、検索窓から「status-check」を入力、選択。<br>\n<img src=\"/images/posts/push-and-test-with-github-actions-1.avif\" alt=\"入力例1\"></p>\n<p>ここまで設定できると、以下のような画面で表示できる。\n<img src=\"/images/posts/push-and-test-with-github-actions-2.avif\" alt=\"動作例1\"></p>\n<p>この設定だと警告が出るがマージはぽちぽちとクリックすればできてしまうので、「Do not allow bypassing the above settings」の設定もしておく。\n<img src=\"/images/posts/push-and-test-with-github-actions-3.avif\" alt=\"設定例2\"></p>\n<p>これでマージするにはコードの変更を余儀なくされる。\n<img src=\"/images/posts/push-and-test-with-github-actions-4.avif\" alt=\"動作例2\"></p>\n<h2 id=\"%E4%BD%99%E8%AB%87\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#%E4%BD%99%E8%AB%87\" aria-hidden=\"true\">#</a> 余談</h2>\n<h3 id=\"%E6%84%8F%E5%9B%B3%E9%80%9A%E3%82%8A%E3%81%84%E3%81%8B%E3%81%AA%E3%81%8B%E3%81%A3%E3%81%9F%E3%81%93%E3%81%A8\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#%E6%84%8F%E5%9B%B3%E9%80%9A%E3%82%8A%E3%81%84%E3%81%8B%E3%81%AA%E3%81%8B%E3%81%A3%E3%81%9F%E3%81%93%E3%81%A8\" aria-hidden=\"true\">#</a> 意図通りいかなかったこと</h3>\n<p><code>npm ci --ignore-scripts</code>コマンドを使って依存関係のインストールが爆速になるかと思ったら、ビルド時に画像フォーマットの変換に使っているsharpを対象に以下のエラーが出た。</p>\n<blockquote>\n<p>Error:<br>\nSomething went wrong installing the &quot;sharp&quot; module\nCannot find module '../build/Release/sharp-linux-x64.node'\nRequire stack:\n/home/runner/work/ikmnjrd.github.io/ikmnjrd.github.io/node_modules/sharp/lib/sharp.js</p>\n</blockquote>\n<p>そのため、<code>$ npm ci</code>とした。</p>\n<h3 id=\"%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE\" aria-hidden=\"true\">#</a> 参考文献</h3>\n<ul>\n<li><a href=\"https://docs.github.com/ja/actions/examples/using-scripts-to-test-your-code-on-a-runner\">スクリプトを使ってランナーでコードをテストする - GitHub Docs</a></li>\n</ul>\n","createdAt":"2022-10-18","updatedAt":"2022-10-18"},"__N_SSG":true}