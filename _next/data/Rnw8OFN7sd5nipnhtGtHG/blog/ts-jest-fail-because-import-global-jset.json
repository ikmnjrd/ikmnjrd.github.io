{"pageProps":{"frontmatter":{"title":"Jest(ts-jest)で作ったはずのmockがundefinedになるエラー","description":"Jestで遭遇したエラー","date":"2022-09-19","tag":["Jest","TypeScript","JavaScript"]},"slug":"ts-jest-fail-because-import-global-jset","innerHtml":"<h3 id=\"%E7%B5%90%E8%AB%96\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#%E7%B5%90%E8%AB%96\" aria-hidden=\"true\">#</a> 結論</h3>\n<p>ts-jest?esmで書いてるから？とりあえずでimportするのやめよう。</p>\n<h3 id=\"%E7%8A%B6%E6%B3%81\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#%E7%8A%B6%E6%B3%81\" aria-hidden=\"true\">#</a> 状況</h3>\n<p>Jestの右も左もわからないがfetcをmockしてゴニョゴニョしていた。<br>\n<a href=\"https://jestjs.io/docs/mock-function-api/#jestmockedsource\">公式の例</a>にもnode-fetchを使った例が載ってるぐらいなので、コピペして動かそうとしていたら問題発生。</p>\n<p>以下のエラーが発生した。</p>\n<pre class=\"language-jsstacktrace\"><code class=\"language-jsstacktrace\"><span class=\"token error-message string\">TypeError: mockGetImageFromWeb.mockClear is not a function</span>\n  23 |\n  24 |   afterEach(() => {\n<span class=\"token error-message string\">> 25 |     mockGetImageFromWeb.mockClear()</span>\n     |                         ^\n  26 |   })\n  27 |   test('should be defined', () => {\n  28 |     expect(getImageFromWeb).toBeDefined()\n</code></pre>\n<p>コピペしたコードはこれ</p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span>expect<span class=\"token punctuation\">,</span> jest<span class=\"token punctuation\">,</span> test<span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'@jest/globals'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> type <span class=\"token punctuation\">{</span>fetch<span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'node-fetch'</span><span class=\"token punctuation\">;</span>\n\njest<span class=\"token punctuation\">.</span><span class=\"token function\">mock</span><span class=\"token punctuation\">(</span><span class=\"token string\">'node-fetch'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">let</span> <span class=\"token literal-property property\">mockedFetch</span><span class=\"token operator\">:</span> jest<span class=\"token punctuation\">.</span>Mocked<span class=\"token operator\">&lt;</span><span class=\"token keyword\">typeof</span> fetch<span class=\"token operator\">></span><span class=\"token punctuation\">;</span>\n\n<span class=\"token function\">afterEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  mockedFetch<span class=\"token punctuation\">.</span><span class=\"token function\">mockClear</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token function\">test</span><span class=\"token punctuation\">(</span><span class=\"token string\">'makes correct call'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  mockedFetch <span class=\"token operator\">=</span> <span class=\"token function\">getMockedFetch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token function\">test</span><span class=\"token punctuation\">(</span><span class=\"token string\">'returns correct data'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  mockedFetch <span class=\"token operator\">=</span> <span class=\"token function\">getMockedFetch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre>\n<h3 id=\"%E5%AF%BE%E5%BF%9C\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#%E5%AF%BE%E5%BF%9C\" aria-hidden=\"true\">#</a> 対応</h3>\n<p>コピペしてきたtestファイルで以下のインポート文を削除したら動いた。</p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> expect<span class=\"token punctuation\">,</span> jest<span class=\"token punctuation\">,</span> test <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'@jest/globals'</span>\n</code></pre>\n<h3 id=\"%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE\" aria-hidden=\"true\">#</a> 参考文献</h3>\n<ul>\n<li><a href=\"https://jestjs.io/docs/mock-function-api/#jestmockedsource\">Mock Functions · Jest</a></li>\n<li><a href=\"https://www.leighhalliday.com/mock-fetch-jest\">How To Mock Fetch in Jest | Leigh Halliday</a></li>\n</ul>\n","createdAt":"2022-10-15","updatedAt":"2022-10-15"},"__N_SSG":true}