{"pageProps":{"frontmatter":{"title":"AWS S3互換のMinIOにaws-sdk(client-s3)から接続する","description":"@aws-sdk/client-s3を利用したMinIOへの接続例のサンプルコード","date":"2022-12-08","tag":["JavaScript","Express.js","AWS"]},"slug":"minio-s3-express-js","innerHtml":"<h3 id=\"%E7%B5%90%E8%AB%96\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#%E7%B5%90%E8%AB%96\" aria-hidden=\"true\">#</a> 結論</h3>\n<p>s3-clientでMinIOに繋げる！</p>\n<h3 id=\"%E7%8A%B6%E6%B3%81\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#%E7%8A%B6%E6%B3%81\" aria-hidden=\"true\">#</a> 状況</h3>\n<p>ローカルで完結する開発環境でもS3にできるだけ近い形をとりたかった。<br>\n<a href=\"https://min.io/\">MinIO</a>というS3互換のオブジェクトストレージが無料らしいので使ってみる。</p>\n<h3 id=\"minio%E5%B0%8E%E5%85%A5\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#minio%E5%B0%8E%E5%85%A5\" aria-hidden=\"true\">#</a> MinIO導入</h3>\n<p>以下のようなディレクトリ構造とする。</p>\n<pre class=\"language-sh\"><code class=\"language-sh\"><span class=\"token builtin class-name\">.</span>\n├── <span class=\"token function\">docker</span>\n│   └── minio\n│       └── data\n├── docker-compose.yml\n</code></pre>\n<pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'3.8'</span>\n<span class=\"token key atrule\">services</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">minio</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> minio/minio<span class=\"token punctuation\">:</span>RELEASE.2022<span class=\"token punctuation\">-</span>11<span class=\"token punctuation\">-</span>29T23<span class=\"token punctuation\">-</span>40<span class=\"token punctuation\">-</span>49Z\n    <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> 9000<span class=\"token punctuation\">:</span><span class=\"token number\">9000</span>\n      <span class=\"token punctuation\">-</span> 9090<span class=\"token punctuation\">:</span><span class=\"token number\">9090</span>\n    <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> MINIO_ROOT_USER=minio\n      <span class=\"token punctuation\">-</span> MINIO_ROOT_PASSWORD=miniopass\n      <span class=\"token punctuation\">-</span> MINIO_VOLUMES=/data\n    <span class=\"token key atrule\">entrypoint</span><span class=\"token punctuation\">:</span> sh\n    <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">-</span>c \"\n      minio server <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>console<span class=\"token punctuation\">-</span>address '<span class=\"token punctuation\">:</span>9090'\"\n    <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> ./docker/minio/data<span class=\"token punctuation\">:</span>/data\n</code></pre>\n<p>コンテナを起動するとlocalhost:9090でminioの管理画面が表示される。</p>\n<h3 id=\"aws-sdk%E3%81%A7minio%E3%81%AB%E6%8E%A5%E7%B6%9A%E3%81%99%E3%82%8B\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#aws-sdk%E3%81%A7minio%E3%81%AB%E6%8E%A5%E7%B6%9A%E3%81%99%E3%82%8B\" aria-hidden=\"true\">#</a> aws-sdkでMinIOに接続する</h3>\n<p><code>s3.js</code></p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> S3Client<span class=\"token punctuation\">,</span> PutObjectCommand <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'@aws-sdk/client-s3'</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token constant\">IS_DEV</span> <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">IS_DEV</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">AWS_S3_REGION</span> <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">AWS_S3_REGION</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">AWS_ACCESS_KEY_ID</span> <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">AWS_ACCESS_KEY_ID</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">AWS_SECRET_ACCESS_KEY</span> <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">AWS_SECRET_ACCESS_KEY</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">AWS_S3_BUCKET_NAME</span> <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">AWS_S3_BUCKET_NAME</span>\n\n\n<span class=\"token keyword\">const</span> s3client <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">S3Client</span><span class=\"token punctuation\">(</span>\n  <span class=\"token constant\">IS_DEV</span>\n    <span class=\"token operator\">?</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token literal-property property\">region</span><span class=\"token operator\">:</span> <span class=\"token constant\">AWS_S3_REGION</span><span class=\"token punctuation\">,</span>\n        <span class=\"token literal-property property\">credentials</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token literal-property property\">accessKeyId</span><span class=\"token operator\">:</span> <span class=\"token string\">'minio'</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// MINIO_ROOT_USER</span>\n          <span class=\"token literal-property property\">secretAccessKey</span><span class=\"token operator\">:</span> <span class=\"token string\">'miniopass'</span> <span class=\"token comment\">// MINIO_ROOT_PASSWORD</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token literal-property property\">endpoint</span><span class=\"token operator\">:</span> <span class=\"token string\">'http://localhost:9000/'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token literal-property property\">forcePathStyle</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token literal-property property\">region</span><span class=\"token operator\">:</span> <span class=\"token constant\">AWS_S3_REGION</span><span class=\"token punctuation\">,</span>\n        <span class=\"token literal-property property\">credentials</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token literal-property property\">accessKeyId</span><span class=\"token operator\">:</span> <span class=\"token constant\">AWS_ACCESS_KEY_ID</span><span class=\"token punctuation\">,</span>\n          <span class=\"token literal-property property\">secretAccessKey</span><span class=\"token operator\">:</span> <span class=\"token constant\">AWS_SECRET_ACCESS_KEY</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">uploadToS3</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">body</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> data <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> s3client<span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span>\n      <span class=\"token keyword\">new</span> <span class=\"token class-name\">PutObjectCommand</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n        <span class=\"token literal-property property\">Bucket</span><span class=\"token operator\">:</span> <span class=\"token constant\">AWS_S3_BUCKET_NAME</span><span class=\"token punctuation\">,</span>\n        <span class=\"token literal-property property\">Key</span><span class=\"token operator\">:</span> <span class=\"token string\">'test/key.png'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token literal-property property\">Body</span><span class=\"token operator\">:</span> body<span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">debug</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Success'</span><span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Error'</span><span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">throw</span> err\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n</code></pre>\n<p><code>index.js</code></p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">import</span> express<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> Router <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'express'</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> uploadToS3 <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'./s3'</span>\n\n<span class=\"token keyword\">const</span> app <span class=\"token operator\">=</span> <span class=\"token function\">express</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> router <span class=\"token operator\">=</span> <span class=\"token function\">Router</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\nrouter<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/image/upload'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 最小のpng</span>\n    <span class=\"token keyword\">const</span> reqBodyMock <span class=\"token operator\">=</span> <span class=\"token string\">'iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAAAAAA6fptVAAAACklEQVQIHWP4DwABAQEANl9ngAAAAABJRU5ErkJggg=='</span>\n\n    <span class=\"token keyword\">await</span> <span class=\"token function\">uploadToS3</span><span class=\"token punctuation\">(</span>reqBodyMock<span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">return</span> res<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">201</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">)</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>router<span class=\"token punctuation\">)</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">listen</span><span class=\"token punctuation\">(</span><span class=\"token string\">'3000'</span><span class=\"token punctuation\">)</span>\n</code></pre>\n<h3 id=\"multers3%E3%81%A7%E3%82%AF%E3%83%A9%E3%82%A4%E3%82%A2%E3%83%B3%E3%83%88%E3%81%AE%E3%83%95%E3%82%A9%E3%83%BC%E3%83%A0%E3%81%8B%E3%82%89%E9%80%81%E4%BF%A1%E3%81%95%E3%82%8C%E3%81%9F%E7%94%BB%E5%83%8F%E3%82%92%E4%BF%9D%E5%AD%98%E3%81%99%E3%82%8B\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#multers3%E3%81%A7%E3%82%AF%E3%83%A9%E3%82%A4%E3%82%A2%E3%83%B3%E3%83%88%E3%81%AE%E3%83%95%E3%82%A9%E3%83%BC%E3%83%A0%E3%81%8B%E3%82%89%E9%80%81%E4%BF%A1%E3%81%95%E3%82%8C%E3%81%9F%E7%94%BB%E5%83%8F%E3%82%92%E4%BF%9D%E5%AD%98%E3%81%99%E3%82%8B\" aria-hidden=\"true\">#</a> multerS3でクライアントのフォームから送信された画像を保存する</h3>\n<p><code>multer.js</code></p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">import</span> multer <span class=\"token keyword\">from</span> <span class=\"token string\">'multer'</span>\n<span class=\"token keyword\">import</span> multerS3 <span class=\"token keyword\">from</span> <span class=\"token string\">'multer-s3'</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> s3client <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'./s3'</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> multerUpload <span class=\"token operator\">=</span> <span class=\"token function\">multer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  <span class=\"token literal-property property\">storage</span><span class=\"token operator\">:</span> <span class=\"token function\">multerS3</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">s3</span><span class=\"token operator\">:</span> s3client<span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">bucket</span><span class=\"token operator\">:</span> <span class=\"token constant\">AWS_S3_BUCKET_NAME</span><span class=\"token punctuation\">,</span>\n    <span class=\"token function-variable function\">metadata</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">_req<span class=\"token punctuation\">,</span> file<span class=\"token punctuation\">,</span> cb</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">cb</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">fieldName</span><span class=\"token operator\">:</span> file<span class=\"token punctuation\">.</span>fieldname <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token function-variable function\">key</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">_req<span class=\"token punctuation\">,</span> file<span class=\"token punctuation\">,</span> cb</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">cb</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> file<span class=\"token punctuation\">.</span>originalname<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n</code></pre>\n<p><code>index.js</code></p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">import</span> express<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> Router <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'express'</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> uploadToS3 <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'./s3'</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> multerUpload <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'./multer'</span>\n\n<span class=\"token keyword\">const</span> app <span class=\"token operator\">=</span> <span class=\"token function\">express</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> router <span class=\"token operator\">=</span> <span class=\"token function\">Router</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\nrouter<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span>\n  <span class=\"token string\">'/image/upload'</span><span class=\"token punctuation\">,</span>\n  multerUpload<span class=\"token punctuation\">.</span><span class=\"token function\">single</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> file <span class=\"token operator\">=</span> req<span class=\"token punctuation\">.</span>file <span class=\"token comment\">// 色々都合のいいファイル（本例だとimage/pngだったり的な）</span>\n\n    <span class=\"token comment\">// s3multerでポート番号が削られてしまうので無理やりつける。</span>\n    <span class=\"token keyword\">const</span> fileLocation <span class=\"token operator\">=</span> <span class=\"token constant\">IS_DEV</span>\n      <span class=\"token operator\">?</span> file<span class=\"token punctuation\">.</span>location<span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span>\n          <span class=\"token regex\"><span class=\"token regex-delimiter\">/</span><span class=\"token regex-source language-regex\">^http:\\/\\/localhost</span><span class=\"token regex-delimiter\">/</span></span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">'http://localhost:9000'</span>\n        <span class=\"token punctuation\">)</span>\n      <span class=\"token operator\">:</span> file<span class=\"token punctuation\">.</span>location\n\n    <span class=\"token keyword\">return</span> res<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token literal-property property\">location</span><span class=\"token operator\">:</span> fileLocation<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">)</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>router<span class=\"token punctuation\">)</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">listen</span><span class=\"token punctuation\">(</span><span class=\"token string\">'3000'</span><span class=\"token punctuation\">)</span>\n</code></pre>\n<h3 id=\"%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE\" aria-hidden=\"true\">#</a> 参考文献</h3>\n<ul>\n<li><a href=\"https://qiita.com/reflet/items/3e0f07bc9d64314515c1\">ローカルS3環境(minio)を構築する - Qiita</a></li>\n<li><a href=\"https://yosiopp.net/archives/225/\">最小のpng画像</a></li>\n</ul>\n<h3 id=\"%E9%96%A2%E9%80%A3%E7%94%A8%E8%AA%9E\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#%E9%96%A2%E9%80%A3%E7%94%A8%E8%AA%9E\" aria-hidden=\"true\">#</a> 関連用語</h3>\n<ul>\n<li>busboy</li>\n<li>multer</li>\n<li>multerS3</li>\n</ul>\n"},"__N_SSG":true}