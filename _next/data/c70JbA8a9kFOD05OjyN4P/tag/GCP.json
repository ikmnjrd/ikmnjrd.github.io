{"pageProps":{"tag":"GCP","posts":[{"slug":"gcp-cloud-build-complain","frontmatter":{"title":"GCPのCloudBuildなんやねんこいつ","date":"2022-01-30","tag":["GCP"]},"content":"### 疑問に遭遇した状況\n最近 Cloud Run にハマってる。Cloud SDK こと gcloud コマンドで Artifact Registry(Container Registry)にアップロードしてほいっと `gcloud run deploy` ですぐにサービスが公開できて気持ちがいい。\n\nじゃあそろそろGithub ActionsでCI/CDの設定でもしようかと思ったら、サービスの概念が自分の中で咀嚼できていなかったことに気がついた。そこでの疑問は以下だ。\n\n### 疑問\n**Cloud Build なんやねんこいつ** である。\n\n`google-github-actions/setup-gcloud` を使ってワークフローを使っていると、次のような形になる。\n\n```yaml\nname: Build and Push Image\n\non:\n  push:\n    tags:\n    - \"*\"\n\njobs:\n  build-and-publish:\n    name: Build and Push docker image\n    runs-on: ubuntu-latest\n\n    steps:\n    - name: Checkout\n      uses: actions/checkout@v2\n      with:\n        ref: ${{ github.ref }}\n\n    - name: Setup Google Cloud\n      uses: google-github-actions/setup-gcloud@v0\n      with:\n        service_account_key: ${{ secrets.GCLOUD_AUTH }}\n        project_id: node-datastore-test-111\n\n    - name: Configure docker for artifact registry\n      run: |\n        gcloud auth configure-docker asia-northeast1-docker.pkg.dev\n\n    - name: set TAG\n      run: |\n        echo \"TAG=$(echo $GITHUB_REF | awk -F/ '{print $NF}')\" >> $GITHUB_ENV\n\n    - name: Build\n      run: |\n        docker build -t asia-northeast1-docker.pkg.dev/node-datastore-test-111/node-datastore-test-repo/node-datastore-test-image:${{ env.TAG }} ./\n\n    - name: Push\n      run: |\n        docker push asia-northeast1-docker.pkg.dev/node-datastore-test-111/node-datastore-test-repo/node-datastore-test-image:${{ env.TAG }}\n\n    - name: Deploy\n      run: |\n        gcloud run deploy test-service --image asia-northeast1-docker.pkg.dev/node-datastore-test-111/node-datastore-test-repo/node-datastore-test-image:${{ env.TAG }} --region asia-northeast1 --platform managed --allow-unauthenticated\n\n```\n\nせっかくdockerコマンドの羅列で気持ちよくなれてたのに、deployはgcloudコマンドに戻ってくる。\n\n...?\nCloud Buildを挟まないとArtifact RegistryからCloud Runへデプロイできないと思い込んでいたけど、Cloud RunにデプロイするためにArtifact RegistryにビルドしたDocker Imageをアップロードしてるだけで、Cloud Buildいらんやん。。。\n\nなんやねん Cloud Build こいつは、でした。\n\n\n### 周辺用語\n- Github Actions\n- Cloud SDK\n- Cloud Build\n\n\n### 参考文献\n- [Cloud Run へのデプロイ](https://cloud.google.com/artifact-registry/docs/integrate-cloud-run#command-line)\n"},{"slug":"gcp-cloudrun-price","frontmatter":{"title":"Google Cloud Runで動かすアプリをRDBに接続した際の料金を考える","date":"2022-01-10","tag":["GCP"]},"content":"\nGoogleが提供してくれているCloud Runは便利ですよね。私は普段Reactでクライアント側を触っていてFirebaseで済ませることが多いのですが、Cloud Runの便利さに感化されてRDBも使いたくなりました。（FirebaseはNoSQLしか提供してくれていないので...）\n\nしかしへっぽこアプリに使うにはいかんせん料金が気になったところで、予想よりも今回の用途には高級すぎました。今回の判断の元になった部分をまとめます。\n\n自称へっぽこアプリへの、想定されるトラフィックとしては1日に1件リクエストがあるかといったレベルのものを想定して話を進めます。\n\nまず第一にCloud Runを使用する。そこにクラウドサービスを利用してRDBを接続したい。\nそうなった時の候補は、次の2つで、こちらの料金を概算していきます。\n1. Cloud Run と Cloud SQL\n2. Cloud RunにホストしたAPIサーバーをVPS上のDBサーバーに繋ぐ\n\n\n\n\n### 注意事項\n1$=100円で計算しています。\n\n料金は全て東京リージョンで計算しています。\n\n\n## **1. Cloud SQLの料金**\n1ヶ月あたり800円。\n\n#### 内訳\n1. ストレージとネットワークの料金\n  * SSD ストレージ容量: 1 GB あたり $0.221/月\n  * HDD ストレージ容量: 1 GB あたり $0.117/月\n2. ネットワーク下り（外向き）の料金\n  * 送信先 Google プロダクトであれば大陸内は無料\n  * インターネット下り（外向き、Cloud Interconnect を使用する場合）は$0.05/GB\n  * インターネット下り（外向き、Cloud Interconnect を使用しない場合）は$0.19/GB\n3. インスタンスの料金\n\n| 共有コア マシンタイプ | 仮想 CPU 数 |RAM（GB） |最大ストレージ容量|1ヶ月あたりの料金（米ドル）\n|:-----------|:------------|:------------|:------------|:------------|\n| db-f1-micro | 共有  | 0.6 | 3,062 GB | $7.67 |\n| db-g1-small | 共有  | 1.7 | 3,062 GB | $25.55 |\n\n\n\nCloudFunctionsで停止と起動をスケジューリングしてことを解説している[Google Cloudのブログ](https://cloud.google.com/blog/ja/topics/developers-practitioners/lower-development-costs-schedule-cloud-sql-instances-start-and-stop)もあります。\n\n\n## **2. 他社VPSにDBサーバを建て接続**\n必要なもの(料金計算対象)\n* VPS(今回はConoHa)\n* Cloud NAT\n* 静的IPアドレス\n\n\n### **ConoHaのVPSの料金**\n1ヶ月あたり682円\n\nメモリ: 512MB、\nCPU: 1コア、\nSSD: 30GB\n\n\n### **Cloud NATの料金**\n1ヶ月あたり数円\n\n| 割り当てられている VM インスタンスの数 | 1 時間あたりの料金 | 処理された 1 GB あたりの料金（下りと上り（外向きと内向き）の両方） |\n|:-----------|:------------|:------------|\n| 32 VM インスタンスまで | $0.0014 × ゲートウェイを使用している VM インスタンスの数 | $0.045   |\n|32 VM インスタンスを超える場合|$0.044|\t$0.045\n\n参考：[https://cloud.google.com/nat/pricing?hl=ja](https://cloud.google.com/nat/pricing?hl=ja)\n\n\n### **静的IPアドレス**\n1ヶ月あたり1,080円\n\n静的IPアドレス（割り当て済み、未使用）\t1時間あたり$0.015\n\n参考:[https://cloud.google.com/compute/all-pricing#ipaddress](https://cloud.google.com/compute/all-pricing#ipaddress)\n\n\n### その他参考\n- [https://cloud.google.com/run/docs/configuring/static-outbound-ip](https://cloud.google.com/run/docs/configuring/static-outbound-ip?hl=ja)\n"},{"slug":"gcp-gcloud-command-often-used","frontmatter":{"title":"よく使うgcloudコマンド","date":"2022-01-09","tag":["GCP"]},"content":"\n主にCloudRun周辺の。すごく個人的なまとめです。\n\n## コマンド\n### 一般枠\n- `gcloud --help`\n- `gcloud config --help`\n- `gcloud config configurations list`\n- `gcloud config configurations create <configuration-name>`\n- `gcloud config configurations activate <configuration-name>`\n- `gcloud projects list`\n- `gcloud config set project <your-project-id>`\n- `gcloud config set project <project-name>`\n- `gcloud projects create <you-project-id> --name <your-project-name>`\n\n\n### Cloud BuildとArtifact RegistryとCloud Run\n- `gcloud services enable  artifactregistry.googleapis.com cloudbuild.googleapis.com`\n- `gcloud artifacts repositories list`\n- ` gcloud artifacts repositories create <repository-name> --repository-format=docker --location=asia-northeast1 --description=\"Docker repository hoge\"`\n- `gcloud builds submit --tag asia-northeast1-docker.pkg.dev/<you-project-id>/<repository-name>/<image-name>:tag1`\n- `gcloud run deploy <service-name> --image asia-northeast1-docker.pkg.dev/<you-project-id>/<repository-name>/<image-name>:tag1 --region asia-northeast1 --platform managed --allow-unauthenticated`\n\n\n### その他メモ\n- `gcloud builds submit`時にカレントディレクトリのDockerfileがアップロードされてビルドされるものだと思ってたけど、[公式ドキュメント](https://cloud.google.com/sdk/gcloud/reference/builds/submit)を見てもそうは書いてない？とりあえずカレントディレクトリの\n- Cloud Runがデフォルトで外部接続に使うポートは8080ってまじ？\n\n"}]},"__N_SSG":true}