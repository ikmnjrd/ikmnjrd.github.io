<!DOCTYPE html><html lang="ja" prefix="og:https://ikmnjrd.github.io/ns#"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1.0"/><meta name="google-site-verification" content="mSJsnnYDqT7YzaY5pkqKhPHifGmwW4pCr2B97rSnleU"/><title>Nuxt.jsのAuthモジュール(@nuxtjs/auth-next)をわからないなりにざっくり解説する | ikmnjrd.github.io</title><meta property="og:url" content="https://ikmnjrd.github.io/blog/nuxt-auth"/><meta property="og:type" content="article"/><meta property="og:image" content="https://ikmnjrd.github.io/images/posts/img1.jpg"/><meta property="og:title" content="Nuxt.jsのAuthモジュール(@nuxtjs/auth-next)をわからないなりにざっくり解説する"/><meta name="description" content="SPA・SSRの認証ライブラリらしい動きに焦点を当てて説明をする"/><meta name="next-head-count" content="9"/><meta name="author" content="ikmnjrd"/><meta charSet="utf-8"/><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"/><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"/><link rel="manifest" href="/site.webmanifest"/><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"/><link rel="alternate" type="application/rss+xml" title="ikmnjrd.github.io - rss" href="/rss/feed.xml"/><meta name="msapplication-TileColor" content="#da532c"/><meta name="theme-color" content="#ffffff"/><link rel="preload" href="/_next/static/css/442d6e4ec70d857b.css" as="style"/><link rel="stylesheet" href="/_next/static/css/442d6e4ec70d857b.css" data-n-g=""/><link rel="preload" href="/_next/static/css/09742170c1498db7.css" as="style"/><link rel="stylesheet" href="/_next/static/css/09742170c1498db7.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-69bfa6990bb9e155.js" defer=""></script><script src="/_next/static/chunks/framework-4556c45dd113b893.js" defer=""></script><script src="/_next/static/chunks/main-bddc4e87d87ec928.js" defer=""></script><script src="/_next/static/chunks/pages/_app-6ce83710a7423286.js" defer=""></script><script src="/_next/static/chunks/pages/blog/%5Bslug%5D-0f82875b0f064b1a.js" defer=""></script><script src="/_next/static/OscRjqzezeM3xi7PoVI3V/_buildManifest.js" defer=""></script><script src="/_next/static/OscRjqzezeM3xi7PoVI3V/_ssgManifest.js" defer=""></script></head><body class="dark:bg-newmo-800 text-newmo-400 dark:text-newmo-100"><div id="__next"><header class="mb-4 p-4 md:px-8 grid grid-cols-1 md:grid-cols-2 max-w-screen-lg mx-auto"><h1 class=""><a class="header-text md:text-5xl text-3xl font-serif decoration-dotted hover:opacity-50 hover:underline active:opacity-30" href="/">ikmnjrd.github.io</a><button class="md:ml-3 ml-2" aria-label="Toggle Theme"><img width="24px" height="24px" class="svg-icon md:w-10 hover:opacity-50 active:opacity-30" src="/light_mode_white_24dp.svg" alt="Dark Mode Status is false" aria-hidden="true"/></button></h1><nav class="text-right"><a class="header-text mr-4 md:text-3xl text-2xl font-serif decoration-dotted hover:opacity-50 hover:underline active:opacity-30" href="/about">About</a><a class="header-text md:text-3xl text-2xl font-serif decoration-dotted hover:opacity-50 hover:underline active:opacity-30" href="/tags">Tags</a></nav></header><main class="max-w-2xl md:mx-auto mx-4 flex flex-col"><h1 class="text-2xl md:text-3xl lg:text-4xl font-bold tracking-tighter leading-tight md:leading-none mb-12 text-center md:text-left">Nuxt.jsのAuthモジュール(@nuxtjs/auth-next)をわからないなりにざっくり解説する</h1><div class="text-right">Posted on <!-- -->2023-05-21</div><img alt=""/><div class="markdown-styles_markdown__tCOlr"><h3 id="tl%3Bdr" tabindex="-1"><a class="header-anchor" href="#tl%3Bdr" aria-hidden="true">#</a> TL;DR</h3>
<ul>
<li>CookieとBrowser Storage(Local Storage)を使ってる</li>
<li>Cookieが消失することを踏まえ、expires/max-ageは本来的な意味で使っていない</li>
</ul>
<h3 id="%E6%99%82%E5%8B%A2%E3%81%AE%E6%84%9A%E7%97%B4" tabindex="-1"><a class="header-anchor" href="#%E6%99%82%E5%8B%A2%E3%81%AE%E6%84%9A%E7%97%B4" aria-hidden="true">#</a> 時勢の愚痴</h3>
<p>Nuxt3.5のリリースが発表された最近ですが、nuxt-communityで開発されているAuthモジュールがいまだに3系に対応できておらず、よくわからん会社がNextAuth(Authentication for Next.js)をラップして作ってるものがNuxt3系をサポートしているよ！なんてことをREADMEに書く始末。<br>
そんなNuxtのAuthモジュールの、2系で動いてるものを見た時に理解した一部を説明します。</p>
<h3 id="%E6%9C%AC%E8%A7%A3%E8%AA%AC%E3%81%AE%E5%89%8D%E6%8F%90" tabindex="-1"><a class="header-anchor" href="#%E6%9C%AC%E8%A7%A3%E8%AA%AC%E3%81%AE%E5%89%8D%E6%8F%90" aria-hidden="true">#</a> 本解説の前提</h3>
<p>ローカルスキーマを拡張した<a href="https://auth.nuxtjs.org/schemes/refresh">リフレッシュスキーマ</a>をもとに解説しています。<br>
設定値の例としては以下です。</p>
<pre class="language-js"><code class="language-js"><span class="token literal-property property">auth</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">cookie</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">options</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">secure</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token literal-property property">sameSite</span><span class="token operator">:</span> <span class="token string">'lax'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">maxAge</span><span class="token operator">:</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">90</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">strategies</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">local</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">scheme</span><span class="token operator">:</span> <span class="token string">'refresh'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">token</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">property</span><span class="token operator">:</span> <span class="token string">'access_token'</span><span class="token punctuation">,</span>
          <span class="token literal-property property">maxAge</span><span class="token operator">:</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">24</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token literal-property property">refreshToken</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">property</span><span class="token operator">:</span> <span class="token string">'refresh_token'</span><span class="token punctuation">,</span>
          <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token string">'refresh_token'</span><span class="token punctuation">,</span>
          <span class="token literal-property property">maxAge</span><span class="token operator">:</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">30</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="%40nuxtjs%2Fauth-next%E3%81%AE%E4%BB%95%E7%B5%84%E3%81%BF" tabindex="-1"><a class="header-anchor" href="#%40nuxtjs%2Fauth-next%E3%81%AE%E4%BB%95%E7%B5%84%E3%81%BF" aria-hidden="true">#</a> @nuxtjs/auth-nextの仕組み</h3>
<p>認証に関わる情報が置かれる場所は主に以下の4つです。</p>
<ul>
<li>Local State(ライブラリ定義)</li>
<li>Universal Storage(ライブラリ定義)</li>
<li>Cookie(Web標準)</li>
<li>Browser Storage(Local Storage)(Web標準)</li>
</ul>
<p>Local Stateはローカルな変数やrefオブジェクトだと理解してもらうとして、CookieもBrowser Storageも情報の保存場所としては馴染み深いと思います。<br>
残るUniversal Storageは、gitでいうところのstagingエリアで、Local Stateに値を入れることをgit commitだと考えると良いかもです。</p>
<img alt="手書き概要" src="/images/posts/nuxt-auth-0.avif" height="250">
<p>Universal Storageの必要性がないかと思われるかもしれませんが、次のような用途があります。</p>
<p>Webサイトに初回のGETリクエストしたユーザーのブラウザに保存されてる認証情報から取り出せるのは基本的にCookieからのみです。<br>
そのため、期限が切れておらず正しい認証情報であれば、SSRをするのに必要な認証情報をLocal Stateに保存すればSSRした結果をユーザーが受け取れてハッピーですが、認証情報が切れている場合は最後までSSRさせてあげることができません。そんな時に役立つのがUniversal StateとBrowser Storageです。</p>
<p>一般的にCookieよりもBrowser Storageに保存したデータの方が長くユーザーのブラウザ内で生き残ります。<br>
そのため、<code>@nuxtjs/auth-next</code>では、Cookieに保存する項目(key)が以下のようになっています。</p>
<ul>
<li>アクセストークン</li>
<li>リフレッシュトークン</li>
<li>アクセストークンの有効期限</li>
<li>リフレッシュトークンの有効期限</li>
</ul>
<p>Cookieには<code>expires/Max-Age</code>という項目がありますが、<code>@nuxtjs/auth-next</code>においてはデフォルトで2週間となっており、ドキュメント内で説明される有効期限とは<code>別物</code>となっています。そのため、</p>
<blockquote>
<p>アクセストークンの有効期限のvalue &gt; <code>expires/Max-Age</code></p>
</blockquote>
<p>といった状況が生まれます。こうなった場合に<code>@nuxtjs/auth-next</code>では特に設定をしなくても使用することになっているBrowser Storageに保存していたアクセストークンやリフレッシュトークンの値を取り出し、認証チャレンジに使用することになっています。</p>
<img alt="手書き概要2" src="/images/posts/nuxt-auth-1.avif" height="300">
<p>ここまで読んでくれた人には申し訳ありませんが、私の理解はここまでです。</p>
<h3 id="cookie%E3%81%A8browser-storage%E3%81%AB%E5%88%86%E3%81%8B%E3%82%8C%E3%81%A6%E3%81%84%E3%82%8B%E3%83%A1%E3%83%AA%E3%83%83%E3%83%88%2F%E3%83%87%E3%83%A1%E3%83%AA%E3%83%83%E3%83%88" tabindex="-1"><a class="header-anchor" href="#cookie%E3%81%A8browser-storage%E3%81%AB%E5%88%86%E3%81%8B%E3%82%8C%E3%81%A6%E3%81%84%E3%82%8B%E3%83%A1%E3%83%AA%E3%83%83%E3%83%88%2F%E3%83%87%E3%83%A1%E3%83%AA%E3%83%83%E3%83%88" aria-hidden="true">#</a> CookieとBrowser Storageに分かれているメリット/デメリット</h3>
<ul>
<li>メリット
<ul>
<li>Cookieのドメイン属性の変更をしてデプロイをしたとき、すでにユーザーが持ってるアクセストークン等が引き続き利用され、期限が切れたタイミングで新規Cookieに切り替わる</li>
</ul>
</li>
<li>デメリット
<ul>
<li>複雑度が増す</li>
</ul>
</li>
</ul>
<h3 id="nuxt3%E3%82%B5%E3%83%9D%E3%83%BC%E3%83%88%E3%81%8C%E3%81%95%E3%82%8C%E3%81%AA%E3%81%84%E7%90%86%E7%94%B1%E3%81%AE%E8%80%83%E5%AF%9F" tabindex="-1"><a class="header-anchor" href="#nuxt3%E3%82%B5%E3%83%9D%E3%83%BC%E3%83%88%E3%81%8C%E3%81%95%E3%82%8C%E3%81%AA%E3%81%84%E7%90%86%E7%94%B1%E3%81%AE%E8%80%83%E5%AF%9F" aria-hidden="true">#</a> Nuxt3サポートがされない理由の考察</h3>
<p>SPA/SSR/SSGモード、認証方式、fetchライブラリ、ストアなどの問題が一番絡み合い、当ライブラリとしても色々な認証方法をサポートしてきた歴史からも互換が切り切れず身動きが取れてない状態だと推測してます。</p>
<p>超雑にようやくすると、「自分でやってくれ」というコメントが好意的なリアクションが多く、受け入れられているようです。</p>
<blockquote>
<p>It would be best if you had released this with at least some basic necessity modules (like auth). There are lots of people using Nuxt. Not all will get understand this thing they will have to do it on their own. It's good that you released it but its also affects people with extra burdens. Keep this in mind.</p>
<p>I am seeing many peoples not shifting to Nuxt 3 because of these basic things.</p>
<p>People are just stuck in between because now you can't even install Nuxt 2 freshly. It throughs a Fatal error while running.</p>
<p>Anyways, it's great to see you guys work so hard on so many things! I really appreciate your contributions to the world. No hard feelings! :)
<cite><a href="https://github.com/nuxt-community/auth-module/issues/1805#issuecomment-1328877117">Compatibility with Nuxt 3?
#1805</a></cite></p>
</blockquote>
<h3 id="%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE" tabindex="-1"><a class="header-anchor" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE" aria-hidden="true">#</a> 参考文献</h3>
<ul>
<li><a href="https://github.com/nuxt-community/auth-module">GitHub - nuxt-community/auth-module: Zero-boilerplate authentication support for Nuxt.js!</a></li>
</ul>
</div></main><footer class="text-center text-sm" role="contentinfo"><div class="footer-content"><ul class="flex items-center justify-between max-w-[150px] mx-auto"><li><a href="https://twitter.com/ikmnjrd" target="_blank" rel="nofollow noopener noreferrer" title="Twitter" class="footer-svg hover:opacity-50 block"><svg xmlns="http://www.w3.org/2000/svg" width="2.3em" height="2.3em" viewBox="0 0 64 64" fill="#fff" stroke="currentColor" stroke-width="2.3"><path d="M54.49 12.3c0-.1-.09-.16-.17-.09-1.57 1.36-5.36 2.46-5.84 2.51a.11.11 0 01-.09 0c-2.78-4.44-9.19-3.24-9.19-3.24C29.78 13.48 30.82 23 31 24c0 .05 0 .09-.09.09-10.48.52-19.63-9.22-20.67-10.37a.11.11 0 00-.17 0A10.57 10.57 0 0012.78 27a.11.11 0 010 .19 12.87 12.87 0 01-4-.77c-.06 0-.13 0-.13.1.14 6.2 6.22 9 7.63 9.59a.1.1 0 010 .19 13.4 13.4 0 01-3.85.27.11.11 0 00-.11.14c1.27 4.78 7.5 6.78 8.62 7.11A.11.11 0 0121 44c-3.85 3.44-11.44 4.35-13 4.51a.11.11 0 00-.06.19c5.82 4 21.06 7.32 32.7-2.63A30.3 30.3 0 0051 21.83a.09.09 0 01.05-.08 14.22 14.22 0 005.06-5.06c0-.1 0-.16-.15-.13a5.63 5.63 0 01-3.15.17s1.71-2.96 1.68-4.43z" stroke-linecap="round"></path></svg></a></li><li><a href="https://github.com/ikmnjrd" target="_blank" rel="nofollow noopener noreferrer" title="GitHub" class="footer-svg header-text hover:opacity-50 block"><svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" viewBox="0 0 24 24" fill="#fff" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg></a></li><li><a href="https://ikmnjrd.github.io/rss/feed.xml" target="_blank" rel="nofollow noopener noreferrer" title="RSS" class="footer-svg header-text hover:opacity-50 block"><svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" viewBox="0 0 24 24" fill="#fff" stroke="currentColor" stroke-width="2.3" stroke-linecap="round" stroke-linejoin="round"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a></li></ul><p>©︎ikmnjrd -<!-- --> <time dateTime="Sat Jun 03 2023 15:44:43 GMT+0000 (Coordinated Universal Time)">2023</time></p></div><div class="wave"></div><div class="wave"></div></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"frontmatter":{"title":"Nuxt.jsのAuthモジュール(@nuxtjs/auth-next)をわからないなりにざっくり解説する","description":"SPA・SSRの認証ライブラリらしい動きに焦点を当てて説明をする","date":"2023-05-21","tag":["Nuxt.js","JavaScript","Vue"]},"slug":"nuxt-auth","innerHtml":"\u003ch3 id=\"tl%3Bdr\" tabindex=\"-1\"\u003e\u003ca class=\"header-anchor\" href=\"#tl%3Bdr\" aria-hidden=\"true\"\u003e#\u003c/a\u003e TL;DR\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003eCookieとBrowser Storage(Local Storage)を使ってる\u003c/li\u003e\n\u003cli\u003eCookieが消失することを踏まえ、expires/max-ageは本来的な意味で使っていない\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"%E6%99%82%E5%8B%A2%E3%81%AE%E6%84%9A%E7%97%B4\" tabindex=\"-1\"\u003e\u003ca class=\"header-anchor\" href=\"#%E6%99%82%E5%8B%A2%E3%81%AE%E6%84%9A%E7%97%B4\" aria-hidden=\"true\"\u003e#\u003c/a\u003e 時勢の愚痴\u003c/h3\u003e\n\u003cp\u003eNuxt3.5のリリースが発表された最近ですが、nuxt-communityで開発されているAuthモジュールがいまだに3系に対応できておらず、よくわからん会社がNextAuth(Authentication for Next.js)をラップして作ってるものがNuxt3系をサポートしているよ！なんてことをREADMEに書く始末。\u003cbr\u003e\nそんなNuxtのAuthモジュールの、2系で動いてるものを見た時に理解した一部を説明します。\u003c/p\u003e\n\u003ch3 id=\"%E6%9C%AC%E8%A7%A3%E8%AA%AC%E3%81%AE%E5%89%8D%E6%8F%90\" tabindex=\"-1\"\u003e\u003ca class=\"header-anchor\" href=\"#%E6%9C%AC%E8%A7%A3%E8%AA%AC%E3%81%AE%E5%89%8D%E6%8F%90\" aria-hidden=\"true\"\u003e#\u003c/a\u003e 本解説の前提\u003c/h3\u003e\n\u003cp\u003eローカルスキーマを拡張した\u003ca href=\"https://auth.nuxtjs.org/schemes/refresh\"\u003eリフレッシュスキーマ\u003c/a\u003eをもとに解説しています。\u003cbr\u003e\n設定値の例としては以下です。\u003c/p\u003e\n\u003cpre class=\"language-js\"\u003e\u003ccode class=\"language-js\"\u003e\u003cspan class=\"token literal-property property\"\u003eauth\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token literal-property property\"\u003ecookie\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token literal-property property\"\u003eoptions\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token literal-property property\"\u003esecure\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token boolean\"\u003etrue\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"token literal-property property\"\u003esameSite\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e'lax'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"token literal-property property\"\u003emaxAge\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token number\"\u003e60\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003e \u003cspan class=\"token number\"\u003e60\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003e \u003cspan class=\"token number\"\u003e24\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003e \u003cspan class=\"token number\"\u003e90\u003c/span\u003e\n      \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token literal-property property\"\u003estrategies\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token literal-property property\"\u003elocal\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token literal-property property\"\u003escheme\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e'refresh'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"token literal-property property\"\u003etoken\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n          \u003cspan class=\"token literal-property property\"\u003eproperty\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e'access_token'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n          \u003cspan class=\"token literal-property property\"\u003emaxAge\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token number\"\u003e60\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003e \u003cspan class=\"token number\"\u003e60\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003e \u003cspan class=\"token number\"\u003e24\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"token literal-property property\"\u003erefreshToken\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n          \u003cspan class=\"token literal-property property\"\u003eproperty\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e'refresh_token'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n          \u003cspan class=\"token literal-property property\"\u003edata\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e'refresh_token'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n          \u003cspan class=\"token literal-property property\"\u003emaxAge\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token number\"\u003e60\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003e \u003cspan class=\"token number\"\u003e60\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003e \u003cspan class=\"token number\"\u003e24\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003e \u003cspan class=\"token number\"\u003e30\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n      \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"%40nuxtjs%2Fauth-next%E3%81%AE%E4%BB%95%E7%B5%84%E3%81%BF\" tabindex=\"-1\"\u003e\u003ca class=\"header-anchor\" href=\"#%40nuxtjs%2Fauth-next%E3%81%AE%E4%BB%95%E7%B5%84%E3%81%BF\" aria-hidden=\"true\"\u003e#\u003c/a\u003e @nuxtjs/auth-nextの仕組み\u003c/h3\u003e\n\u003cp\u003e認証に関わる情報が置かれる場所は主に以下の4つです。\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eLocal State(ライブラリ定義)\u003c/li\u003e\n\u003cli\u003eUniversal Storage(ライブラリ定義)\u003c/li\u003e\n\u003cli\u003eCookie(Web標準)\u003c/li\u003e\n\u003cli\u003eBrowser Storage(Local Storage)(Web標準)\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eLocal Stateはローカルな変数やrefオブジェクトだと理解してもらうとして、CookieもBrowser Storageも情報の保存場所としては馴染み深いと思います。\u003cbr\u003e\n残るUniversal Storageは、gitでいうところのstagingエリアで、Local Stateに値を入れることをgit commitだと考えると良いかもです。\u003c/p\u003e\n\u003cimg alt=\"手書き概要\" src=\"/images/posts/nuxt-auth-0.avif\" height=\"250\"\u003e\n\u003cp\u003eUniversal Storageの必要性がないかと思われるかもしれませんが、次のような用途があります。\u003c/p\u003e\n\u003cp\u003eWebサイトに初回のGETリクエストしたユーザーのブラウザに保存されてる認証情報から取り出せるのは基本的にCookieからのみです。\u003cbr\u003e\nそのため、期限が切れておらず正しい認証情報であれば、SSRをするのに必要な認証情報をLocal Stateに保存すればSSRした結果をユーザーが受け取れてハッピーですが、認証情報が切れている場合は最後までSSRさせてあげることができません。そんな時に役立つのがUniversal StateとBrowser Storageです。\u003c/p\u003e\n\u003cp\u003e一般的にCookieよりもBrowser Storageに保存したデータの方が長くユーザーのブラウザ内で生き残ります。\u003cbr\u003e\nそのため、\u003ccode\u003e@nuxtjs/auth-next\u003c/code\u003eでは、Cookieに保存する項目(key)が以下のようになっています。\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eアクセストークン\u003c/li\u003e\n\u003cli\u003eリフレッシュトークン\u003c/li\u003e\n\u003cli\u003eアクセストークンの有効期限\u003c/li\u003e\n\u003cli\u003eリフレッシュトークンの有効期限\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eCookieには\u003ccode\u003eexpires/Max-Age\u003c/code\u003eという項目がありますが、\u003ccode\u003e@nuxtjs/auth-next\u003c/code\u003eにおいてはデフォルトで2週間となっており、ドキュメント内で説明される有効期限とは\u003ccode\u003e別物\u003c/code\u003eとなっています。そのため、\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eアクセストークンの有効期限のvalue \u0026gt; \u003ccode\u003eexpires/Max-Age\u003c/code\u003e\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eといった状況が生まれます。こうなった場合に\u003ccode\u003e@nuxtjs/auth-next\u003c/code\u003eでは特に設定をしなくても使用することになっているBrowser Storageに保存していたアクセストークンやリフレッシュトークンの値を取り出し、認証チャレンジに使用することになっています。\u003c/p\u003e\n\u003cimg alt=\"手書き概要2\" src=\"/images/posts/nuxt-auth-1.avif\" height=\"300\"\u003e\n\u003cp\u003eここまで読んでくれた人には申し訳ありませんが、私の理解はここまでです。\u003c/p\u003e\n\u003ch3 id=\"cookie%E3%81%A8browser-storage%E3%81%AB%E5%88%86%E3%81%8B%E3%82%8C%E3%81%A6%E3%81%84%E3%82%8B%E3%83%A1%E3%83%AA%E3%83%83%E3%83%88%2F%E3%83%87%E3%83%A1%E3%83%AA%E3%83%83%E3%83%88\" tabindex=\"-1\"\u003e\u003ca class=\"header-anchor\" href=\"#cookie%E3%81%A8browser-storage%E3%81%AB%E5%88%86%E3%81%8B%E3%82%8C%E3%81%A6%E3%81%84%E3%82%8B%E3%83%A1%E3%83%AA%E3%83%83%E3%83%88%2F%E3%83%87%E3%83%A1%E3%83%AA%E3%83%83%E3%83%88\" aria-hidden=\"true\"\u003e#\u003c/a\u003e CookieとBrowser Storageに分かれているメリット/デメリット\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003eメリット\n\u003cul\u003e\n\u003cli\u003eCookieのドメイン属性の変更をしてデプロイをしたとき、すでにユーザーが持ってるアクセストークン等が引き続き利用され、期限が切れたタイミングで新規Cookieに切り替わる\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eデメリット\n\u003cul\u003e\n\u003cli\u003e複雑度が増す\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"nuxt3%E3%82%B5%E3%83%9D%E3%83%BC%E3%83%88%E3%81%8C%E3%81%95%E3%82%8C%E3%81%AA%E3%81%84%E7%90%86%E7%94%B1%E3%81%AE%E8%80%83%E5%AF%9F\" tabindex=\"-1\"\u003e\u003ca class=\"header-anchor\" href=\"#nuxt3%E3%82%B5%E3%83%9D%E3%83%BC%E3%83%88%E3%81%8C%E3%81%95%E3%82%8C%E3%81%AA%E3%81%84%E7%90%86%E7%94%B1%E3%81%AE%E8%80%83%E5%AF%9F\" aria-hidden=\"true\"\u003e#\u003c/a\u003e Nuxt3サポートがされない理由の考察\u003c/h3\u003e\n\u003cp\u003eSPA/SSR/SSGモード、認証方式、fetchライブラリ、ストアなどの問題が一番絡み合い、当ライブラリとしても色々な認証方法をサポートしてきた歴史からも互換が切り切れず身動きが取れてない状態だと推測してます。\u003c/p\u003e\n\u003cp\u003e超雑にようやくすると、「自分でやってくれ」というコメントが好意的なリアクションが多く、受け入れられているようです。\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eIt would be best if you had released this with at least some basic necessity modules (like auth). There are lots of people using Nuxt. Not all will get understand this thing they will have to do it on their own. It's good that you released it but its also affects people with extra burdens. Keep this in mind.\u003c/p\u003e\n\u003cp\u003eI am seeing many peoples not shifting to Nuxt 3 because of these basic things.\u003c/p\u003e\n\u003cp\u003ePeople are just stuck in between because now you can't even install Nuxt 2 freshly. It throughs a Fatal error while running.\u003c/p\u003e\n\u003cp\u003eAnyways, it's great to see you guys work so hard on so many things! I really appreciate your contributions to the world. No hard feelings! :)\n\u003ccite\u003e\u003ca href=\"https://github.com/nuxt-community/auth-module/issues/1805#issuecomment-1328877117\"\u003eCompatibility with Nuxt 3?\n#1805\u003c/a\u003e\u003c/cite\u003e\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003ch3 id=\"%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE\" tabindex=\"-1\"\u003e\u003ca class=\"header-anchor\" href=\"#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE\" aria-hidden=\"true\"\u003e#\u003c/a\u003e 参考文献\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/nuxt-community/auth-module\"\u003eGitHub - nuxt-community/auth-module: Zero-boilerplate authentication support for Nuxt.js!\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n"},"__N_SSG":true},"page":"/blog/[slug]","query":{"slug":"nuxt-auth"},"buildId":"OscRjqzezeM3xi7PoVI3V","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>